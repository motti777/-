<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒ£ãƒƒãƒˆ (ãƒ¡ãƒ¼ãƒ«èªè¨¼å¯¾å¿œ)</title>
    
    <style> 
</head>
body {
    font-family: apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background-color: #36393f;
    color: #dcddde;
    margin: 0;
    display: flex;
    flex-direction: column;
    height: 100vh;
    overflow: hidden;
}

/* ãƒ­ã‚°ã‚¤ãƒ³ãƒ»ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ */
#login-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}
#login-box {
    background: #2f3136;
    padding: 30px;
    border-radius: 8px;
    width: 400px;
    box-sizing: border-box;
}
/* ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ */
.login-tabs {
    display: flex;
    margin-bottom: 20px;
}
.login-tab {
    flex: 1;
    padding: 10px;
    text-align: center;
    cursor: pointer;
    border-bottom: 2px solid #202225;
    color: #8e9297;
    font-weight: bold;
}
.login-tab.active {
    color: #dcddde;
    border-bottom: 2px solid #5865f2;
}
/* ãƒ•ã‚©ãƒ¼ãƒ  */
.login-form-group {
    margin-bottom: 15px;
}
.login-form-group label {
    display: block;
    margin-bottom: 5px;
    color: #b9bbbe;
    font-size: 0.9em;
}
.login-form-group input {
    width: 100%;
    padding: 10px;
    background: #202225;
    border: 1px solid #40444b;
    color: #dcddde;
    border-radius: 5px;
    box-sizing: border-box;
}
.login-btn {
    background: #5865f2;
    color: white;
    border: none;
    padding: 12px 20px;
    font-size: 1em;
    border-radius: 5px;
    cursor: pointer;
    width: 100%;
    margin-top: 10px;
}
/* Googleãƒ­ã‚°ã‚¤ãƒ³ */
#google-login-btn {
    background: #fff;
    color: #747d86;
    font-weight: bold;
}
#google-login-btn::before {
    content: 'G';
    font-family: Googleã‚¢ã‚¤ã‚³ãƒ³ã®ä»£ã‚ã‚Šã«;
    color: #db4437;
    margin-right: 10px;
    font-weight: bold;
}
/* ã‚¨ãƒ©ãƒ¼è¡¨ç¤º */
.divider {
    text-align: center;
    color: #8e9297;
    margin: 20px 0;
    font-size: 0.9em;
}
.error-message {
    color: #f04747;
    margin-top: 15px;
    text-align: center;
    font-size: 0.9em;
    min-height: 1.2em;
}

/* ã“ã“ã‹ã‚‰ã¯ãƒãƒ£ãƒƒãƒˆç”»é¢ã®CSS */

/* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
#sidebar {
    width: 240px;
    background: #2f3136;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}
#sidebar-scroll-container {
    flex-grow: 1;
    overflow-y: auto;
}

/* ãƒãƒ£ãƒ³ãƒãƒ«ãƒªã‚¹ãƒˆã‚³ãƒ³ãƒ†ãƒŠ */
#channel-list-container {
    padding: 10px;
}

/* ãƒãƒ£ãƒ³ãƒãƒ«è¦‹å‡ºã— */
#channel-list-container h3 {
    margin: 10px 5px 5px 5px;
    color: #8e9297;
    font-size: 0.8em;
    text-transform: uppercase;
    cursor: pointer;
}
#channel-list-container h3:hover {
    color: #dcddde;
}

/* ãƒãƒ£ãƒ³ãƒãƒ«ãƒœã‚¿ãƒ³ */
.channel-list button {
    background: none;
    border: none;
    color: #b9bbbe;
    width: 100%;
    text-align: left;
    padding: 8px 10px;
    margin-bottom: 5px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.9em;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.channel-list button:hover:not(.active) {
    background: #3a3c43;
}
.channel-list button.active {
    background: #40444b;
    color: #dcddde;
    font-weight: 500;
}
/* ãƒãƒ£ãƒ³ãƒãƒ«å‰Šé™¤ãƒœã‚¿ãƒ³ */
.delete-channel {
    color: #f04747;
    cursor: pointer;
    margin-left: 5px;
    flex-shrink: 0;
}

/* ãƒãƒ£ãƒ³ãƒãƒ«ä½œæˆãƒ•ã‚©ãƒ¼ãƒ  */
.create-channel-btn {
    background: #40444b;
    color: #dcddde;
    border: none;
    padding: 10px;
    width: calc(100% - 20px);
    margin: 10px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.9em;
}
.create-channel-btn:hover {
    background: #4e5058;
}

/* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
#main-content {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    padding: 20px 20px 0 20px;
    overflow: hidden;
}

/* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ */
.chat-area {
    flex-grow: 1;
    overflow-y: auto;
    padding-bottom: 20px; /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›ã‚¨ãƒªã‚¢ã¨ã®é–“éš” */
}

/* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›ã‚¨ãƒªã‚¢ */
.message-input-area {
    background: #40444b;
    padding: 10px;
    border-radius: 5px;
    display: flex;
    margin-bottom: 20px;
    width: 100%;
    max-width: 1000px;
    align-self: center;
}
#message-input {
    flex-grow: 1;
    background: none;
    border: none;
    color: #dcddde;
    padding: 5px;
    font-size: 1em;
    outline: none;
    resize: none;
    max-height: 100px;
    overflow-y: auto;
}
#send-button {
    background: #5865f2;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 5px;
    cursor: pointer;
    margin-left: 10px;
    flex-shrink: 0;
}
#file-input-label {
    background: #4f545c;
    color: white;
    border-radius: 5px;
    padding: 8px;
    cursor: pointer;
    margin-right: 10px;
    flex-shrink: 0;
    line-height: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 20px;
    height: 20px;
}
#file-input {
    display: none;
}

/* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.message {
    margin-bottom: 15px;
    padding: 5px;
    position: relative;
}
.message-header {
    display: flex;
    align-items: center;
    margin-bottom: 2px;
}
.sender {
    font-weight: bold;
    color: #fff;
    margin-right: 8px;
    font-size: 0.9em;
}
.timestamp {
    color: #8e9297;
    font-size: 0.75em;
}
.text {
    color: #dcddde;
    line-height: 1.4;
    word-wrap: break-word;
    margin: 0;
}
.message-image {
    max-width: 300px;
    max-height: 300px;
    margin-top: 5px;
    border-radius: 5px;
    cursor: pointer;
}
/* å‰Šé™¤ãƒœã‚¿ãƒ³ */
.delete-message {
    background: #f04747;
    color: white;
    border: none;
    padding: 3px 6px;
    border-radius: 3px;
    cursor: pointer;
    font-size: 0.75em;
    margin-left: 10px;
    position: absolute;
    right: 0;
    top: 0;
    opacity: 0;
    transition: opacity 0.2s;
}
.message:hover .delete-message {
    opacity: 1;
}
/* ç®¡ç†è€…ç”¨ã®ç›®å° */
.admin-indicator {
    color: #faa61a;
    margin-left: 5px;
    font-size: 0.8em;
}
/* BANã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.message-sender-admin-bannable {
    cursor: pointer;
    text-decoration: underline;
    text-decoration-color: #f04747;
    margin-left: 5px;
}
.message-sender-admin-bannable:hover {
    text-decoration-color: #ff7f7f;
}


/* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ¢ãƒ¼ãƒ€ãƒ« */
#profile-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 2000;
}
#profile-modal {
    background: #2f3136;
    padding: 30px;
    border-radius: 8px;
    width: 350px;
    box-sizing: border-box;
    color: #dcddde;
}
#profile-modal h2 {
    color: #fff;
    margin-top: 0;
    border-bottom: 1px solid #40444b;
    padding-bottom: 10px;
}
.profile-info {
    margin-bottom: 20px;
}
.profile-info p {
    margin: 5px 0;
}
.profile-info span {
    font-weight: bold;
}
/* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  */
.profile-form-group {
    margin-bottom: 15px;
}
.profile-form-group label {
    display: block;
    margin-bottom: 5px;
    color: #b9bbbe;
    font-size: 0.9em;
}
.profile-form-group input {
    width: 100%;
    padding: 10px;
    background: #202225;
    border: 1px solid #40444b;
    color: #dcddde;
    border-radius: 5px;
    box-sizing: border-box;
}
#update-name-button, #logout-button, #open-profile-button {
    background: #5865f2;
    color: white;
    border: none;
    padding: 10px;
    border-radius: 5px;
    cursor: pointer;
    width: 100%;
    margin-top: 10px;
}
#logout-button {
    background: #f04747;
}
#close-profile-button {
    background: #40444b;
    color: #dcddde;
    border: none;
    padding: 10px;
    border-radius: 5px;
    cursor: pointer;
    width: 100%;
    margin-top: 10px;
}
/* éè¡¨ç¤ºã‚¯ãƒ©ã‚¹ */
.hidden {
    display: none !important;
}

/* --- ã“ã“ã‹ã‚‰AIãƒãƒ£ãƒ³ãƒãƒ«ç”¨ã®è¿½åŠ CSS --- */

/* AI BOTã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.ai-message .text {
    color: #ccc; /* å¿œç­”ä¸­ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’è–„ã */
}

/* ãƒ­ãƒ¼ãƒ‰ä¸­ã®ãƒ‰ãƒƒãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
.loading-dot {
    animation: blink 1s infinite;
}

/* 3ã¤ã®ãƒ‰ãƒƒãƒˆãŒé †ç•ªã«ç‚¹æ»…ã™ã‚‹ã‚ˆã†ã«ãƒ‡ã‚£ãƒ¬ã‚¤ã‚’è¨­å®š */
.loading-dot:nth-child(2) {
    animation-delay: 0.2s;
}

.loading-dot:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes blink {
    0%, 100% { opacity: 0.2; }
    50% { opacity: 1; }
}
/* --- AIãƒãƒ£ãƒ³ãƒãƒ«ç”¨ã®è¿½åŠ CSSã¯ã“ã“ã¾ã§ --- */
    </style>
	 <script src="https://unpkg.com/@google/genai@0.1.0/dist/client.umd.js"></script>
</head>
	</head>
</head><body>

    <div id="login-overlay">
        <div id="login-box">
            <div class="login-tabs">
                <div class="login-tab active" data-tab="login">ãƒ­ã‚°ã‚¤ãƒ³</div>
                <div class="login-tab" data-tab="register">æ–°è¦ç™»éŒ²</div>
            </div>

            <form id="login-form">
                <div class="login-form-group">
                    <label for="login-email">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                    <input type="email" id="login-email" required>
                </div>
                <div class="login-form-group">
                    <label for="login-password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                    <input type="password" id="login-password" required>
                </div>
                <button type="submit" class="login-btn">ãƒ­ã‚°ã‚¤ãƒ³</button>
            </form>
            
            <form id="register-form" class="hidden">
                <div class="login-form-group">
                    <label for="register-name">è¡¨ç¤ºå</label>
                    <input type="text" id="register-name" required>
                </div>
                <div class="login-form-group">
                    <label for="register-email">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                    <input type="email" id="register-email" required>
                </div>
                <div class="login-form-group">
                    <label for="register-password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ6æ–‡å­—ä»¥ä¸Šï¼‰</label>
                    <input type="password" id="register-password" required>
                </div>
                <button type="submit" class="login-btn">ç™»éŒ²ã™ã‚‹</button>
            </form>

            <div class="divider">ã¾ãŸã¯</div>
            
            <button id="google-login-btn" class="login-btn">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
            
            <p id="login-error"></p>
        </div>
    </div>

    <div id="sidebar" class="hidden"> <div id="sidebar-scroll-container">
            <div id="channel-list-container">
                <h3>å…¬é–‹ãƒãƒ£ãƒ³ãƒãƒ«</h3>
                <ul id="public-channel-list" class="channel-list"></ul>
                <h3>ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒãƒ£ãƒ³ãƒãƒ«</h3>
                <ul id="private-channel-list" class="channel-list"></ul>
            </div>
            <div class="sidebar-form-container">
                <form id="join-private-form" class="sidebar-form">
                    <input type="text" id="join-id-input" placeholder="å‚åŠ IDï¼ˆåˆè¨€è‘‰ï¼‰" autocomplete="off" required>
                    <button type="submit">IDã§ãƒãƒ£ãƒ³ãƒãƒ«ã«å‚åŠ </button>
                </form>
                <hr style="border-color: #40444b; margin: 15px 0;">
                <form id="add-channel-form" class="sidebar-form">
                    <input type="text" id="add-channel-input" placeholder="æ–°ã—ã„ãƒãƒ£ãƒ³ãƒãƒ«å" autocomplete="off" required>
                    <input type="text" id="secret-id-input" placeholder="IDï¼ˆåˆè¨€è‘‰ï¼‰ã‚’è¨­å®š" autocomplete="off" class="hidden">
                    <div class="checkbox-group">
                        <input type="checkbox" id="is-private-checkbox">
                        <label for="is-private-checkbox" style="margin-left: 5px;">IDä»˜ãï¼ˆéå…¬é–‹ï¼‰ã«ã™ã‚‹</label>
                    </div>
                    <button type="submit">ãƒãƒ£ãƒ³ãƒãƒ«ä½œæˆ</button>
                </form>
            </div>
        </div> 
        <div id="user-info-bar">
            <img id="user-icon" src="" alt="icon">
            <span id="user-name"></span>
            <button id="settings-btn" title="ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®š">âš™ï¸</button>
            
            <button id="logout-btn" title="ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ">ğŸšª</button>
        </div>
    </div>

    <div id="main-content" class="hidden"> <div id="main-header">#<span id="current-channel-name">general</span></div>
        <div id="message-list"></div>
        <form id="message-form">
            <input type="text" id="message-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡..." autocomplete="off">
        </form>
    </div>
    
    <div id="profile-modal-overlay" class="hidden">
        <div id="profile-modal">
            <h2>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ç·¨é›†</h2>
            <div class="form-group">
                <label for="profile-name-input">è¡¨ç¤ºå</label>
                <input type="text" id="profile-name-input">
            </div>
            <div class="form-group">
                <label for="profile-icon-input">ã‚¢ã‚¤ã‚³ãƒ³URL</label>
                <input type="text" id="profile-icon-input" placeholder="https://example.com/image.png">
            </div>
            <div class="modal-buttons">
                <button id="profile-cancel-btn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="profile-save-btn">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase SDK ã®ã‚³ã‚¢ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        // èªè¨¼ (Auth) ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        import { 
            getAuth, 
            GoogleAuthProvider, 
            signInWithPopup, 
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut // â˜… ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ©Ÿèƒ½
        } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        // Firestore ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        import { 
            getFirestore, collection, addDoc, query, orderBy, onSnapshot, 
            serverTimestamp, doc, setDoc, updateDoc, getDoc, where,
            arrayUnion, deleteDoc,
            getDocs 
        } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

// Firebaseã®è¨­å®šã¨åˆæœŸåŒ–ï¼ˆã“ã“ã¯ã‚ãªãŸã®æƒ…å ±ãŒå…¥ã£ã¦ã„ã¾ã™ï¼‰
const firebaseConfig = {
    apiKey: "AIzaSyAp_61BOWyl_p5TZRylDbOSWF6q8JceQNw", // ã“ã“ã¯ã‚ãªãŸã®ã‚­ãƒ¼
    authDomain: "sexsex-90a07.firebaseapp.com", // ã“ã“ã¯ã‚ãªãŸã®ãƒ‰ãƒ¡ã‚¤ãƒ³
    projectId: ""sexsex-90a07", // ã“ã“ã¯ã‚ãªãŸã®ID
    storageBucket: "sexsex-90a07.appspot.com",
    messagingSenderId: "123456789012",
    appId: "1:123456789012:web:abcdefg",
    measurementId: "..."
};

// --- ã“ã“ã‹ã‚‰ãŒAIæ©Ÿèƒ½ã®è¿½åŠ ãƒ»ä¿®æ­£ã‚³ãƒ¼ãƒ‰ã§ã™ ---

// AIæ©Ÿèƒ½ã§ä½¿ã†å®šæ•°
const AI_CHANNEL_ID = 'ai_chat';
const AI_BOT_UID = 'AI_BOT_UID'; 
const AI_BOT_NAME = 'ğŸ¤– AI BOT';

// â˜…â˜…â˜… å±é™º! APIã‚­ãƒ¼ã‚’ã“ã“ã«ç›´æ¥å…¬é–‹ã—ã¾ã™ â˜…â˜…â˜…
// ã‚ãªãŸã®APIã‚­ãƒ¼ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã®ä¸­ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„
const GEMINI_API_KEY = "AIzaSyAp_61BOWyl_p5TZRylDbOSWF6q8JceQNw"; // â˜…â˜…â˜… ã“ã“ã‚’æ›¸ãæ›ãˆã‚‹ â˜…â˜…â˜…

// AIãƒ¢ãƒ‡ãƒ«ã®åˆæœŸåŒ– (ãƒ–ãƒ©ã‚¦ã‚¶å´ã§APIã‚­ãƒ¼ã‚’ä½¿ã£ã¦åˆæœŸåŒ–)
let aiClient;
try {
    // CDNã§èª­ã¿è¾¼ã‚“ã GoogleGenAIã‚’åˆæœŸåŒ–
    aiClient = new GoogleGenAI({ apiKey: GEMINI_API_KEY });
} catch(e) {
    console.error("Gemini APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚APIã‚­ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚", e);
}


// Firebase Appã®åˆæœŸåŒ–ã¨ã‚µãƒ¼ãƒ“ã‚¹ã®å–å¾—
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();
const app = firebase.app();

let currentChannelId = 'general';
let currentUserName = '';

// ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸ã®é·ç§»
if (!auth.currentUser) {
    location.href = 'login.html';
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ç®¡ç†
let userInfo = {}; // uidã‚’ã‚­ãƒ¼ã¨ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’æ ¼ç´
let blacklist = []; // ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®uidã‚’æ ¼ç´

// --- é–¢æ•°å®šç¾© ---

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
async function sendMessage(text, file = null) {
    const user = auth.currentUser;
    if (!user) return;
    const uid = user.uid;

    if (blacklist.includes(uid)) {
        alert('ã‚ãªãŸã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã§ãã¾ã›ã‚“ã€‚');
        return;
    }

    if (!text && !file) return;

    let imageUrl = null;

    if (file) {
        const fileRef = storage.ref().child(`images/${uid}/${Date.now()}-${file.name}`);
        const snapshot = await fileRef.put(file);
        imageUrl = await snapshot.ref.getDownloadURL();
    }

    // 1. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’Firestoreã«é€ä¿¡
    await db.collection('channels').doc(currentChannelId).collection('messages').add({
        text: text,
        uid: uid,
        imageUrl: imageUrl,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    // 2. AIãƒãƒ£ãƒ³ãƒãƒ«ã®å ´åˆã¯AIå¿œç­”å‡¦ç†ã‚’å®Ÿè¡Œ
    if (currentChannelId === AI_CHANNEL_ID && aiClient && text.trim() !== '') {
        await processAIResponse(text);
    }
}

// AIå¿œç­”ã‚’ç”Ÿæˆã—ã¦Firestoreã«æ›¸ãè¾¼ã‚€æ–°ã—ã„é–¢æ•°
async function processAIResponse(userText) {
    // å¿œç­”ä¸­ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒãƒ£ãƒƒãƒˆã«è¡¨ç¤ºï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã®ãŸã‚ï¼‰
    const loadingMessageRef = await db.collection('channels').doc(AI_CHANNEL_ID).collection('messages').add({
        text: 'AIãŒå¿œç­”ã‚’è€ƒãˆã¦ã„ã¾ã™...',
        uid: AI_BOT_UID, // AI BOTã¨ã—ã¦é€ä¿¡
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        // ãƒ­ãƒ¼ãƒ‰ä¸­ã‚’ç¤ºã™ãŸã‚ã®ç‰¹æ®Šãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
        isLoading: true 
    });

    try {
        // Gemini APIã‚’ç›´æ¥å©ã
        const response = await aiClient.models.generateContent({
            model: 'gemini-2.5-flash',
            contents: userText,
        });

        const aiResponseText = response.text;
        
        // AIã®å¿œç­”ã‚’Firestoreã«æ›¸ãè¾¼ã¿ï¼ˆãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›´æ–°ï¼‰
        await loadingMessageRef.update({
            text: aiResponseText,
            isLoading: firebase.firestore.FieldValue.delete() // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ•ãƒ©ã‚°ã‚’å‰Šé™¤
        });

    } catch (error) {
        console.error("AIå¿œç­”ã‚¨ãƒ©ãƒ¼:", error);

        // å¤±æ•—ã—ãŸå ´åˆã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¿”ã™
        await loadingMessageRef.update({
            text: `[AIã‚¨ãƒ©ãƒ¼] å¿œç­”ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚­ãƒ¼ãŒæ­£ã—ã„ã‹ã€ã¾ãŸã¯APIã®åˆ©ç”¨ãŒåˆ¶é™ã•ã‚Œã¦ã„ãªã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚`,
            uid: AI_BOT_UID, 
            isLoading: firebase.firestore.FieldValue.delete()
        });
    }
}


// ãƒãƒ£ãƒ³ãƒãƒ«å‰Šé™¤
async function deleteChannel(channelId) {
    if (channelId === AI_CHANNEL_ID) {
        alert('AIãƒãƒ£ãƒ³ãƒãƒ«ã¯å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚');
        return;
    }
    if (confirm('ã“ã®ãƒãƒ£ãƒ³ãƒãƒ«ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
        await db.collection('channels').doc(channelId).delete();
    }
}

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‰Šé™¤
async function deleteMessage(channelId, messageId, messageUid) {
    const user = auth.currentUser;
    if (!user) return;

    // AI BOTã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ç®¡ç†è€…ã®ã¿å‰Šé™¤å¯èƒ½ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡è€…ã¯AI BOTè‡ªèº«ï¼‰
    const isBotMessage = (messageUid === AI_BOT_UID);
    const isAdmin = (user.email === 'mottikoyama@gmail.com');

    if (messageUid !== user.uid && !isAdmin) {
        alert('ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚');
        return;
    }

    if (isBotMessage && !isAdmin) {
         alert('AI BOTã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ç®¡ç†è€…ã®ã¿å‰Šé™¤ã§ãã¾ã™ã€‚');
        return;
    }


    if (confirm('ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
        await db.collection('channels').doc(channelId).collection('messages').doc(messageId).delete();
    }
}

// ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
function logout() {
    auth.signOut().then(() => {
        location.href = 'login.html';
    });
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±æ›´æ–°
async function updateUserInfo(uid, data) {
    await db.collection('users').doc(uid).update(data);
}

// UIè¨­å®š
function setupUI(user) {
    document.getElementById('profile-name').textContent = user.displayName || user.email;
    document.getElementById('profile-email').textContent = user.email;

    // ç®¡ç†è€…UIã®è¡¨ç¤º
    if (user.email === 'mottikoyama@gmail.com') {
        document.getElementById('admin-tools').style.display = 'block';
    } else {
        document.getElementById('admin-tools').style.display = 'none';
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
    document.getElementById('send-button').onclick = () => {
        const textInput = document.getElementById('message-input');
        const text = textInput.value;
        const fileInput = document.getElementById('file-input');
        const file = fileInput.files[0];
        
        if (text.trim() !== '' || file) {
            sendMessage(text, file);
            textInput.value = '';
            fileInput.value = '';
        }
    };
    
    // ãƒãƒ£ãƒ³ãƒãƒ«ä½œæˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
    document.getElementById('create-channel-button').onclick = async () => {
        const channelName = prompt('æ–°ã—ã„ãƒãƒ£ãƒ³ãƒãƒ«åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
        if (channelName && channelName.trim() !== '' && channelName !== AI_BOT_NAME + 'ã¨è©±ã™') {
            await db.collection('channels').add({
                name: channelName,
                ownerId: user.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
    };

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼åæ›´æ–°ãƒ•ã‚©ãƒ¼ãƒ ã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
    document.getElementById('update-name-button').onclick = () => {
        const newName = document.getElementById('new-name-input').value;
        if (newName) {
            user.updateProfile({ displayName: newName }).then(() => {
                updateUserInfo(user.uid, { name: newName });
                document.getElementById('profile-name').textContent = newName;
                currentUserName = newName;
                document.getElementById('new-name-input').value = '';
            });
        }
    };
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãƒªã‚¹ãƒŠãƒ¼
function setupUserListener() {
    db.collection('users').onSnapshot(snapshot => {
        snapshot.forEach(doc => {
            userInfo[doc.id] = doc.data();
        });
    });
}

// ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆãƒªã‚¹ãƒŠãƒ¼
function setupBlacklistListener() {
    db.collection('blacklist').onSnapshot(snapshot => {
        blacklist = [];
        snapshot.forEach(doc => {
            blacklist.push(doc.id);
        });
    });
}

// ãƒãƒ£ãƒ³ãƒãƒ«UIè¨­å®š
function setupChannelUI(channelId) {
    const channelElements = document.querySelectorAll('.channel-list button');
    channelElements.forEach(button => {
        button.classList.remove('active');
        if (button.dataset.channelId === channelId) {
            button.classList.add('active');
        }
    });

    document.getElementById('current-channel-name').textContent = document.querySelector(`.channel-list button[data-channel-id="${channelId}"]`).textContent.replace(' ğŸ—‘ï¸', '');
}

// ãƒãƒ£ãƒ³ãƒãƒ«ãƒªã‚¹ãƒˆãƒªã‚¹ãƒŠãƒ¼
function setupChannelListener() {
    db.collection('channels').orderBy('createdAt', 'asc').onSnapshot(snapshot => {
        const channelList = document.getElementById('channel-list');
        channelList.innerHTML = ''; // æ—¢å­˜ã®ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢

        let channelFound = false;

        snapshot.forEach(doc => {
            const channelData = doc.data();
            const channelId = doc.id;
            
            // ãƒãƒ£ãƒ³ãƒãƒ«ãƒœã‚¿ãƒ³ä½œæˆ
            const button = document.createElement('button');
            button.dataset.channelId = channelId;
            button.textContent = channelData.name;
            
            button.onclick = () => {
                currentChannelId = channelId;
                setupChannelUI(channelId);
                setupMessageListener(channelId);
            };

            // å‰Šé™¤ãƒœã‚¿ãƒ³ã®è¿½åŠ ï¼ˆAIãƒãƒ£ãƒ³ãƒãƒ«ã¨Permanentãªãƒãƒ£ãƒ³ãƒãƒ«ã¯ä¸å¯ï¼‰
            if (channelData.ownerId === auth.currentUser.uid || auth.currentUser.email === 'mottikoyama@gmail.com') {
                if (channelId !== AI_CHANNEL_ID && !channelData.isPermanent) {
                    const deleteButton = document.createElement('span');
                    deleteButton.textContent = ' ğŸ—‘ï¸';
                    deleteButton.classList.add('delete-channel');
                    deleteButton.onclick = (e) => {
                        e.stopPropagation(); // ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’åœæ­¢
                        deleteChannel(channelId);
                    };
                    button.appendChild(deleteButton);
                }
            }

            channelList.appendChild(button);

            if (channelId === currentChannelId) {
                channelFound = true;
            }
        });

        if (!channelFound) {
            // ç¾åœ¨ã®ãƒãƒ£ãƒ³ãƒãƒ«ãŒå‰Šé™¤ã•ã‚ŒãŸå ´åˆã€generalã«æˆ»ã‚‹
            currentChannelId = 'general';
        }

        setupChannelUI(currentChannelId);
        setupMessageListener(currentChannelId);
    });
}

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æç”»
function renderMessage(messageData, messageElement) {
    const user = auth.currentUser;
    const senderInfo = userInfo[messageData.uid] || { name: 'Unknown User', email: '' };
    const isAdmin = (user.email === 'mottikoyama@gmail.com');
    
    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®HTMLã‚’æ§‹æˆ
    messageElement.innerHTML = `
        <div class="message-header">
            <span class="sender">${senderInfo.name || messageData.uid}</span>
            <span class="timestamp">${messageData.timestamp ? new Date(messageData.timestamp.toDate()).toLocaleTimeString() : '...'}</span>
        </div>
        <div class="message-content">
            <p class="text">${messageData.text || ''}</p>
            ${messageData.imageUrl ? `<img src="${messageData.imageUrl}" class="message-image" alt="Image">` : ''}
        </div>
    `;

    // AI BOTã®è¡¨ç¤ºåè¨­å®š
    if (messageData.uid === AI_BOT_UID) {
        // AI BOTã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆã€è‰²ã‚’å¤‰ãˆã€åå‰ã‚‚AI BOTã«ã™ã‚‹
        messageElement.classList.add('ai-message');
        const senderElement = messageElement.querySelector('.sender');
        if (senderElement) {
            senderElement.textContent = AI_BOT_NAME;
            senderElement.style.color = '#7289da'; // Discordã‚«ãƒ©ãƒ¼ã®é’ç´«è‰²
        }

        // ãƒ­ãƒ¼ãƒ‰ä¸­ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆã¯ç‰¹æ®Šãªå‡¦ç†
        if (messageData.isLoading) {
             messageElement.querySelector('.text').innerHTML += ' <span class="loading-dot">.</span><span class="loading-dot">.</span><span class="loading-dot">.</span>';
        }
    }


    // å‰Šé™¤ãƒœã‚¿ãƒ³ã®è¿½åŠ ï¼ˆè‡ªåˆ†ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ç®¡ç†è€…ãªã‚‰ï¼‰
    if (messageData.uid === user.uid || isAdmin || messageData.uid === AI_BOT_UID) {
        const deleteButton = document.createElement('button');
        deleteButton.textContent = 'å‰Šé™¤';
        deleteButton.classList.add('delete-message');
        deleteButton.onclick = () => {
            deleteMessage(currentChannelId, messageElement.dataset.messageId, messageData.uid);
        };
        messageElement.appendChild(deleteButton);
    }
}

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¹ãƒŠãƒ¼
function setupMessageListener(channelId) {
    const messageContainer = document.getElementById('messages');
    messageContainer.innerHTML = ''; // æ—¢å­˜ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢

    db.collection('channels').doc(channelId).collection('messages').orderBy('timestamp', 'asc').onSnapshot(snapshot => {
        snapshot.docChanges().forEach(change => {
            const messageData = change.doc.data();
            const messageId = change.doc.id;
            
            if (change.type === 'added') {
                const messageElement = document.createElement('div');
                messageElement.classList.add('message');
                messageElement.dataset.messageId = messageId;
                messageElement.dataset.uid = messageData.uid;
                
                renderMessage(messageData, messageElement);
                messageContainer.appendChild(messageElement);
                messageContainer.scrollTop = messageContainer.scrollHeight; // ä¸€ç•ªä¸‹ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            }

            if (change.type === 'modified') {
                const messageElement = document.querySelector(`.message[data-message-id="${messageId}"]`);
                if (messageElement) {
                    renderMessage(messageData, messageElement);
                }
            }

            if (change.type === 'removed') {
                const messageElement = document.querySelector(`.message[data-message-id="${messageId}"]`);
                if (messageElement) {
                    messageContainer.removeChild(messageElement);
                }
            }
        });
    });
}

// åˆæœŸåŒ–æ™‚ã«AIãƒãƒ£ãƒ³ãƒãƒ«ã®å­˜åœ¨ã‚’ç¢ºèªã—ã€ãªã‘ã‚Œã°è‡ªå‹•ã§ä½œæˆã™ã‚‹é–¢æ•°
async function checkAndCreateAIChannel() {
    const aiChannelRef = db.collection('channels').doc(AI_CHANNEL_ID);
    
    // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ã£ã¦ã€ãƒãƒ£ãƒ³ãƒãƒ«ã®å­˜åœ¨ç¢ºèªã¨ä½œæˆã‚’åŒæ™‚ã«è¡Œã†
    await db.runTransaction(async (transaction) => {
        const doc = await transaction.get(aiChannelRef);
        
        if (!doc.exists) {
            console.log("AIãƒãƒ£ãƒ³ãƒãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚");
            transaction.set(aiChannelRef, {
                name: AI_BOT_NAME + 'ã¨è©±ã™',
                ownerId: AI_BOT_UID, // å‰Šé™¤ã•ã‚Œãªã„ã‚ˆã†ã«BOTã®UIDã‚’è¨­å®š
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                isPermanent: true // å‰Šé™¤ã•ã‚Œãªã„ã‚ˆã†ã«ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
            });
        }
    }).catch(error => {
        console.error("AIãƒãƒ£ãƒ³ãƒãƒ«ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼:", error);
    });
}


// ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–
async function initializeApp() {
    // ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã®ç›£è¦–
    auth.onAuthStateChanged(user => {
        if (user) {
            setupUI(user);
            setupUserListener();
            setupBlacklistListener();
            
            // ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«AIãƒãƒ£ãƒ³ãƒãƒ«ã‚’å¿…ãšä½œæˆãƒ»è¡¨ç¤ºã™ã‚‹
            checkAndCreateAIChannel(); 

            // æ—¢å­˜ã®generalãƒãƒ£ãƒ³ãƒãƒ«ãŒãªã‘ã‚Œã°ä½œæˆ
            db.collection('channels').doc('general').get().then(doc => {
                if (!doc.exists) {
                    db.collection('channels').doc('general').set({
                        name: 'General',
                        ownerId: 'admin',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        isPermanent: true
                    });
                }
            });

            setupChannelListener();

        } else {
            location.href = 'login.html';
        }
    });
}


// ç®¡ç†è€…æ©Ÿèƒ½ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆã«è¿½åŠ 
async function addToBlacklist(uid) {
    if (auth.currentUser.email !== 'mottikoyama@gmail.com') {
        alert('ç®¡ç†è€…ã®ã¿å®Ÿè¡Œã§ãã¾ã™ã€‚');
        return;
    }
    if (confirm(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${uid} ã‚’ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) {
        await db.collection('blacklist').doc(uid).set({ addedBy: auth.currentUser.uid, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
        alert(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${uid} ã‚’ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸã€‚`);
    }
}

// ã‚¢ãƒ—ãƒªèµ·å‹•
initializeApp();
    </script>
</body>
</html>
