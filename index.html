<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒ£ãƒƒãƒˆ (ãƒãƒ£ãƒ³ãƒãƒ«æ©Ÿèƒ½ä»˜ã)</title>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #36393f;
            color: #dcddde;
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ */
        #login-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8); display: flex;
            justify-content: center; align-items: center; z-index: 1000;
        }
        #login-box {
            background: #2f3136; padding: 40px; border-radius: 8px; text-align: center;
        }
        #login-btn {
            background: #5865f2; color: white; border: none;
            padding: 10px 20px; font-size: 1.2em; border-radius: 5px; cursor: pointer;
        }

        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
        #sidebar {
            width: 240px;
            background: #2f3136;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
        }
        /* ãƒãƒ£ãƒ³ãƒãƒ«ãƒªã‚¹ãƒˆ */
        #channel-list-container {
            flex-grow: 1;
            padding: 10px;
            overflow-y: auto;
        }
        #channel-list-container h3 {
            margin: 10px 5px 5px;
            color: #8e9297;
            font-size: 0.8em;
            text-transform: uppercase;
        }
        .channel-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .channel-item {
            padding: 8px 10px;
            border-radius: 5px;
            cursor: pointer;
            color: #8e9297;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .channel-item:hover {
            background: #3a3c43;
            color: #dcddde;
        }
        .channel-item.active {
            background: #40444b;
            color: #ffffff;
        }
        .channel-item .lock-icon {
            margin-right: 5px;
            color: #b9bbbe;
        }
        
        /* â˜…ãƒãƒ£ãƒ³ãƒãƒ«å‚åŠ /ä½œæˆãƒ•ã‚©ãƒ¼ãƒ â˜… */
        .sidebar-form-container {
            padding: 10px;
            border-top: 1px solid #40444b;
        }
        .sidebar-form {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .sidebar-form input[type="text"] {
            background: #202225;
            border: none;
            color: #dcddde;
            padding: 8px;
            border-radius: 3px;
            font-size: 0.9em;
        }
        .sidebar-form button {
            background: #5865f2;
            color: white;
            border: none;
            padding: 8px;
            border-radius: 3px;
            cursor: pointer;
        }
        /* â˜…ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆCHä½œæˆã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹â˜… */
        .checkbox-group {
            display: flex;
            align-items: center;
            font-size: 0.9em;
            color: #b9bbbe;
        }

        /* ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± (ã‚µã‚¤ãƒ‰ãƒãƒ¼ä¸‹éƒ¨) */
        #user-info-bar {
            background: #292b2f; padding: 10px; display: flex;
            align-items: center; flex-shrink: 0;
        }
        #user-info-bar img {
            width: 32px; height: 32px; border-radius: 50%; margin-right: 10px;
        }
        #user-info-bar span {
            font-size: 0.9em; font-weight: 500;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-grow: 1;
        }
        #settings-btn {
            background: none; border: none; color: #b9bbbe;
            font-size: 1.2em; cursor: pointer; margin-left: auto; padding: 5px; flex-shrink: 0;
        }
        #settings-btn:hover { color: #fff; }

        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
        #main-content {
            flex-grow: 1; display: flex; flex-direction: column; background: #36393f;
        }
        #main-header {
            padding: 20px; border-bottom: 1px solid #40444b;
            box-shadow: 0 1px 0 rgba(0,0,0,.2); font-size: 1.2em;
            font-weight: bold; color: #fff;
        }

        /* ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ */
        #message-list {
            flex-grow: 1; padding: 20px; overflow-y: auto;
        }
        .message { margin-bottom: 15px; display: flex; }
        .message-icon { width: 40px; height: 40px; border-radius: 50%; margin-right: 15px; flex-shrink: 0; }
        .message-content { padding-top: 5px; }
        .message-sender { font-weight: bold; color: #fff; margin-bottom: 5px; }
        .message-text { line-height: 1.4; color: #dcddde; }

        /* é€ä¿¡ãƒ•ã‚©ãƒ¼ãƒ  */
        #message-form {
            display: flex; padding: 20px; background: #40444b;
        }
        #message-input {
            flex-grow: 1; background: #484c52; border: none;
            border-radius: 8px; padding: 10px 15px;
            color: #dcddde; font-size: 1em; outline: none;
        }
        
        /* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« (CSSã¯å¤‰æ›´ãªã—) */
        #profile-modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8); display: flex;
            justify-content: center; align-items: center; z-index: 2000;
        }
        #profile-modal { background: #2f3136; padding: 30px; border-radius: 8px; width: 400px; }
        #profile-modal h2 { margin-top: 0; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; color: #b9bbbe; }
        .form-group input { width: 100%; padding: 10px; background: #202225; border: 1px solid #40444b; color: #dcddde; border-radius: 5px; box-sizing: border-box; }
        .modal-buttons { display: flex; justify-content: flex-end; margin-top: 20px; }
        .modal-buttons button { border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; margin-left: 10px; }
        #profile-cancel-btn { background: #747f8d; color: white; }
        #profile-save-btn { background: #5865f2; color: white; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div id="login-box">
            <h2>ãƒãƒ£ãƒƒãƒˆã¸ã‚ˆã†ã“ã</h2>
            <button id="login-btn">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
        </div>
    </div>

    <div id="sidebar">
        <div id="channel-list-container">
            <h3>å…¬é–‹ãƒãƒ£ãƒ³ãƒãƒ«</h3>
            <ul id="public-channel-list" class="channel-list">
                </ul>
            
            <h3>ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒãƒ£ãƒ³ãƒãƒ«</h3>
            <ul id="private-channel-list" class="channel-list">
                </ul>
        </div>
        
        <div class="sidebar-form-container">
            <form id="join-private-form" class="sidebar-form">
                <input type="text" id="join-id-input" placeholder="å‚åŠ IDï¼ˆåˆè¨€è‘‰ï¼‰" autocomplete="off" required>
                <button type="submit">IDã§ãƒãƒ£ãƒ³ãƒãƒ«ã«å‚åŠ </button>
            </form>
            
            <hr style="border-color: #40444b; margin: 15px 0;">
            
            <form id="add-channel-form" class="sidebar-form">
                <input type="text" id="add-channel-input" placeholder="æ–°ã—ã„ãƒãƒ£ãƒ³ãƒãƒ«å" autocomplete="off" required>
                <input type="text" id="secret-id-input" placeholder="IDï¼ˆåˆè¨€è‘‰ï¼‰ã‚’è¨­å®š" autocomplete="off" class="hidden">
                <div class="checkbox-group">
                    <input type="checkbox" id="is-private-checkbox">
                    <label for="is-private-checkbox" style="margin-left: 5px;">IDä»˜ãï¼ˆéå…¬é–‹ï¼‰ã«ã™ã‚‹</label>
                </div>
                <button type="submit">ãƒãƒ£ãƒ³ãƒãƒ«ä½œæˆ</button>
            </form>
        </div>
        
        <div id="user-info-bar" class="hidden">
            <img id="user-icon" src="" alt="icon">
            <span id="user-name"></span>
            <button id="settings-btn" title="ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®š">âš™ï¸</button>
        </div>
    </div>

    <div id="main-content">
        <div id="main-header">
            #
            <span id="current-channel-name">general</span>
        </div>
        <div id="message-list"></div>
        <form id="message-form">
            <input type="text" id="message-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡..." autocomplete="off">
        </form>
    </div>
    
    <div id="profile-modal-overlay" class="hidden">
        <div id="profile-modal">
            <h2>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ç·¨é›†</h2>
            <div class="form-group">
                <label for="profile-name-input">è¡¨ç¤ºå</label>
                <input type="text" id="profile-name-input">
            </div>
            <div class="form-group">
                <label for="profile-icon-input">ã‚¢ã‚¤ã‚³ãƒ³URL</label>
                <input type="text" id="profile-icon-input" placeholder="https://example.com/image.png">
            </div>
            <div class="modal-buttons">
                <button id="profile-cancel-btn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="profile-save-btn">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase SDK ã®ã‚³ã‚¢ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        // èªè¨¼ (Auth) ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        // Firestore ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        import { 
            getFirestore, collection, addDoc, query, orderBy, onSnapshot, 
            serverTimestamp, doc, setDoc, updateDoc, getDoc, where,
            arrayUnion // â˜…é…åˆ—ã«è¦ç´ ã‚’è¿½åŠ ã™ã‚‹
        } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // â˜…â˜…â˜… ã‚ãªãŸã®Firebaseè¨­å®š (çµ„ã¿è¾¼ã¿æ¸ˆã¿) â˜…â˜…â˜…
        const firebaseConfig = {
          apiKey: "AIzaSyAhXs223e-Shn8JfnvNC1IS4-T33mtKd-k",
          authDomain: "sexsex-90a07.firebaseapp.com",
          projectId: "sexsex-90a07",
          storageBucket: "sexsex-90a07.firebasestorage.app",
          messagingSenderId: "252347983312",
          appId: "1:252347983312:web:89019e1ee68879839385d5"
        };
        // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…

        // Firebase ã‚¢ãƒ—ãƒªã‚’åˆæœŸåŒ–
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // DOMè¦ç´ ã®å–å¾—
        const loginOverlay = document.getElementById('login-overlay');
        const loginBtn = document.getElementById('login-btn');
        const userInfoBar = document.getElementById('user-info-bar');
        const userIcon = document.getElementById('user-icon');
        const userName = document.getElementById('user-name');
        const messageList = document.getElementById('message-list');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        
        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£
        const settingsBtn = document.getElementById('settings-btn');
        const profileModalOverlay = document.getElementById('profile-modal-overlay');
        const profileNameInput = document.getElementById('profile-name-input');
        const profileIconInput = document.getElementById('profile-icon-input');
        const profileCancelBtn = document.getElementById('profile-cancel-btn');
        const profileSaveBtn = document.getElementById('profile-save-btn');
        
        // â˜…ãƒãƒ£ãƒ³ãƒãƒ«é–¢é€£ã®DOM
        const publicChannelList = document.getElementById('public-channel-list');
        const privateChannelList = document.getElementById('private-channel-list');
        const addChannelForm = document.getElementById('add-channel-form');
        const addChannelInput = document.getElementById('add-channel-input');
        const isPrivateCheckbox = document.getElementById('is-private-checkbox');
        const secretIdInput = document.getElementById('secret-id-input');
        const joinPrivateForm = document.getElementById('join-private-form');
        const joinIdInput = document.getElementById('join-id-input');
        const currentChannelName = document.getElementById('current-channel-name');

        let currentUser = null;
        let usersMap = {}; 
        let currentMessages = [];
        
        let currentChannelId = 'general'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
        let unsubscribeMessages = null; // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç›£è¦–ã®åœæ­¢ç”¨
        let unsubscribeMyProfile = null; // è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ç›£è¦–ã®åœæ­¢ç”¨

        // --- 1. èªè¨¼ (ãƒ­ã‚°ã‚¤ãƒ³) å‡¦ç† ---
        
        loginBtn.addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try { await signInWithPopup(auth, provider); } catch (error) { console.error("ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:", error); }
        });

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ
                currentUser = user;
                loginOverlay.classList.add('hidden'); 
                
                await setupUserProfile(user); // ãƒ¦ãƒ¼ã‚¶ãƒ¼åç°¿(users)ã‚’æº–å‚™
                
                // â˜…è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã¨ã€å‚åŠ ä¸­ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆCHã‚’ç›£è¦–
                listenToMyProfileAndPrivateChannels(user.uid); 
                
                userInfoBar.classList.remove('hidden'); // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãƒãƒ¼ã‚’è¡¨ç¤º
                
                listenToUsers(); // å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åç°¿ã‚’ç›£è¦–
                listenToPublicChannels(); // â˜…å…¬é–‹ãƒãƒ£ãƒ³ãƒãƒ«ä¸€è¦§ã‚’ç›£è¦–
                switchChannel('general', 'general'); // â˜…ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®generalã«æ¥ç¶š
                
            } else {
                // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆçŠ¶æ…‹
                currentUser = null;
                loginOverlay.classList.remove('hidden'); 
                userInfoBar.classList.add('hidden'); 
                messageList.innerHTML = ''; 
                publicChannelList.innerHTML = '';
                privateChannelList.innerHTML = '';
                if (unsubscribeMessages) unsubscribeMessages();
                if (unsubscribeMyProfile) unsubscribeMyProfile();
            }
        });
        
        // â˜…ãƒ¦ãƒ¼ã‚¶ãƒ¼åç°¿(users)ã‚’æº–å‚™ (å‚åŠ CHãƒªã‚¹ãƒˆã‚’è¿½åŠ )
        async function setupUserProfile(user) {
            const userRef = doc(db, "users", user.uid);
            const userDoc = await getDoc(userRef);
            if (!userDoc.exists()) {
                await setDoc(userRef, {
                    displayName: user.displayName,
                    photoURL: user.photoURL,
                    joinedPrivateChannels: [] // â˜…å‚åŠ æ¸ˆã¿CHã®IDã‚’ä¿å­˜ã™ã‚‹é…åˆ—
                });
            }
        }
        
        // â˜…è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã¨ã€å‚åŠ ä¸­ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆCHã‚’ç›£è¦–
        function listenToMyProfileAndPrivateChannels(uid) {
            const userRef = doc(db, "users", uid);
            // ç›£è¦–ã‚’åœæ­¢ã§ãã‚‹ã‚ˆã†ã«
            unsubscribeMyProfile = onSnapshot(userRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    // ã‚µã‚¤ãƒ‰ãƒãƒ¼ä¸‹éƒ¨ã«è‡ªåˆ†ã®æƒ…å ±ã‚’è¡¨ç¤º
                    userIcon.src = data.photoURL;
                    userName.textContent = data.displayName;
                    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã«ã‚‚å€¤ã‚’ã‚»ãƒƒãƒˆ
                    profileNameInput.value = data.displayName;
                    profileIconInput.value = data.photoURL;
                    
                    // â˜…å‚åŠ ä¸­ã®ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆCHã‚’æç”»
                    renderPrivateChannels(data.joinedPrivateChannels || []);
                }
            });
        }
        
        // â˜…ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆCHãƒªã‚¹ãƒˆã‚’æç”»ã™ã‚‹
        async function renderPrivateChannels(idArray) {
            privateChannelList.innerHTML = ''; // ã„ã£ãŸã‚“ã‚¯ãƒªã‚¢
            for (const id of idArray) {
                const channelDoc = await getDoc(doc(db, "channels", id));
                if (channelDoc.exists()) {
                    const channel = channelDoc.data();
                    const li = createChannelElement(channelDoc.id, channel.name, true); // ğŸ”’ä»˜ãã§ä½œæˆ
                    privateChannelList.appendChild(li);
                }
            }
        }

        // --- 2. ãƒãƒ£ãƒ³ãƒãƒ«å‡¦ç† ---
        
        // â˜…å…¬é–‹ãƒãƒ£ãƒ³ãƒãƒ«(public)ã‚’ç›£è¦–ã™ã‚‹
        function listenToPublicChannels() {
            // â˜…secretId ãŒ null (è¨­å®šãªã—) ã®ã‚‚ã®ã ã‘ã‚’ã‚¯ã‚¨ãƒª
            const q = query(collection(db, "channels"), where("secretId", "==", null), orderBy("name"));
            
            onSnapshot(q, (snapshot) => {
                publicChannelList.innerHTML = ''; // ã‚¯ãƒªã‚¢
                let channelsExist = false;

                snapshot.forEach((doc) => {
                    channelsExist = true;
                    const channel = doc.data();
                    const li = createChannelElement(doc.id, channel.name, false); // ğŸ”’ãªã—ã§ä½œæˆ
                    publicChannelList.appendChild(li);
                });
                
                // â˜…ã‚‚ã—å…¬é–‹CHãŒä¸€ã¤ã‚‚ç„¡ã‘ã‚Œã°ã€'general' ã‚’è‡ªå‹•ä½œæˆ
                if (!channelsExist) {
                    addDoc(collection(db, "channels"), { name: "general", secretId: null });
                }
            });
        }
        
        // â˜…ãƒãƒ£ãƒ³ãƒãƒ«ãƒªã‚¹ãƒˆã®HTMLè¦ç´ ã‚’ä½œæˆã™ã‚‹å…±é€šé–¢æ•°
        function createChannelElement(id, name, isPrivate) {
            const li = document.createElement('li');
            li.className = 'channel-item';
            li.dataset.id = id; // HTMLè¦ç´ ã«IDã‚’ä¿å­˜
            
            let namePrefix = '# ';
            if (isPrivate) {
                namePrefix = '<span class="lock-icon">ğŸ”’</span> ';
            }
            li.innerHTML = `${namePrefix} ${name}`;
            
            if (id === currentChannelId) {
                li.classList.add('active');
            }
            
            // â˜…ãƒãƒ£ãƒ³ãƒãƒ«ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸæ™‚ã®å‡¦ç†
            li.addEventListener('click', () => {
                switchChannel(id, name);
            });
            return li;
        }
        
        // â˜…ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆCHä½œæˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å‡¦ç†
        isPrivateCheckbox.addEventListener('change', () => {
            secretIdInput.classList.toggle('hidden', !isPrivateCheckbox.checked);
            if (isPrivateCheckbox.checked) {
                secretIdInput.required = true;
            } else {
                secretIdInput.required = false;
            }
        });

        // â˜…ãƒãƒ£ãƒ³ãƒãƒ«ã€Œä½œæˆã€ãƒ•ã‚©ãƒ¼ãƒ ã®å‡¦ç†
        addChannelForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const channelName = addChannelInput.value.trim();
            if (channelName === '' || !currentUser) return;
            
            const newChannelData = {
                name: channelName,
                secretId: null // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ public (null)
            };
            
            if (isPrivateCheckbox.checked) {
                // â˜…ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆCHã®å ´åˆ
                const secretId = secretIdInput.value.trim();
                if (secretId === '') {
                    alert('IDï¼ˆåˆè¨€è‘‰ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                newChannelData.secretId = secretId;
            }
            
            try {
                // "channels" ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«æ–°ã—ã„ãƒãƒ£ãƒ³ãƒãƒ«ã‚’è¿½åŠ 
                const docRef = await addDoc(collection(db, "channels"), newChannelData);
                
                // â˜…ã‚‚ã—ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆCHã‚’ä½œæˆã—ãŸã‚‰ã€è‡ªåˆ†ã‚‚è‡ªå‹•ã§å‚åŠ ã™ã‚‹
                if (newChannelData.secretId !== null) {
                    const userRef = doc(db, "users", currentUser.uid);
                    await updateDoc(userRef, {
                        joinedPrivateChannels: arrayUnion(docRef.id)
                    });
                    // æ–°ã—ãä½œã£ãŸCHã«è‡ªå‹•ã§åˆ‡ã‚Šæ›¿ãˆ
                    switchChannel(docRef.id, newChannelData.name);
                }

                addChannelInput.value = '';
                secretIdInput.value = '';
                isPrivateCheckbox.checked = false;
                secretIdInput.classList.add('hidden');

            } catch (error) {
                console.error("ãƒãƒ£ãƒ³ãƒãƒ«è¿½åŠ ã‚¨ãƒ©ãƒ¼:", error);
            }
        });
        
        // â˜…IDã§ã€Œå‚åŠ ã€ã™ã‚‹ãƒ•ã‚©ãƒ¼ãƒ ã®å‡¦ç†
        joinPrivateForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const secretId = joinIdInput.value.trim();
            if (secretId === '' || !currentUser) return;
            
            // â˜…secretId (åˆè¨€è‘‰) ãŒä¸€è‡´ã™ã‚‹ãƒãƒ£ãƒ³ãƒãƒ«ã‚’æ¤œç´¢
            const q = query(collection(db, "channels"), where("secretId", "==", secretId));
            const snapshot = await getDoc(q);
            
            if (snapshot.empty) {
                alert('IDï¼ˆåˆè¨€è‘‰ï¼‰ãŒé–“é•ã£ã¦ã„ã‚‹ã‹ã€ãƒãƒ£ãƒ³ãƒãƒ«ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚');
            } else {
                // â˜…è¦‹ã¤ã‹ã£ãŸ (åˆè¨€è‘‰ã¯ãƒ¦ãƒ‹ãƒ¼ã‚¯å‰æ)
                const foundDoc = snapshot.docs[0];
                const channelId = foundDoc.id;
                
                // è‡ªåˆ†ã®åç°¿(users)ã«ã€ã“ã®ãƒãƒ£ãƒ³ãƒãƒ«IDã‚’ã€Œå‚åŠ æ¸ˆã¿ã€ã¨ã—ã¦è¿½åŠ 
                const userRef = doc(db, "users", currentUser.uid);
                await updateDoc(userRef, {
                    joinedPrivateChannels: arrayUnion(channelId)
                });
                
                // å‚åŠ ã—ãŸãƒãƒ£ãƒ³ãƒãƒ«ã«åˆ‡ã‚Šæ›¿ãˆ
                switchChannel(channelId, foundDoc.data().name);
                joinIdInput.value = '';
            }
        });
        
        // â˜…ãƒãƒ£ãƒ³ãƒãƒ«ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹é–¢æ•°
        function switchChannel(channelId, channelName) {
            // å‰ã®ãƒãƒ£ãƒ³ãƒãƒ«ã®ç›£è¦–ã‚’åœæ­¢
            if (unsubscribeMessages) {
                unsubscribeMessages();
            }
            
            currentChannelId = channelId; // ç¾åœ¨ã®ãƒãƒ£ãƒ³ãƒãƒ«IDã‚’æ›´æ–°
            currentChannelName.textContent = channelName; // ãƒ˜ãƒƒãƒ€ãƒ¼ã®åå‰ã‚’æ›´æ–°
            
            // â˜…ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’æ›´æ–° (ä¸¡æ–¹ã®ãƒªã‚¹ãƒˆã‹ã‚‰æ¢ã™)
            document.querySelectorAll('.channel-item').forEach(el => {
                el.classList.toggle('active', el.dataset.id === channelId);
            });
            
            // â˜…æ–°ã—ã„ãƒãƒ£ãƒ³ãƒãƒ«ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç›£è¦–ã‚’é–‹å§‹
            listenToMessages(channelId);
        }

        // --- 3. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€å—ä¿¡å‡¦ç† (å¤‰æ›´ãªã—) ---
        
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ (channelId ã‚’è¿½åŠ )
        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault(); 
            const text = messageInput.value.trim();
            if (text === '' || !currentUser) return;
            try {
                await addDoc(collection(db, "messages"), {
                    text: text,
                    senderId: currentUser.uid, 
                    channelId: currentChannelId, // â˜…ã©ã®ãƒãƒ£ãƒ³ãƒãƒ«ã¸ã®æŠ•ç¨¿ã‹IDã‚’è¨˜éŒ²
                    timestamp: serverTimestamp() 
                });
                messageInput.value = '';
            } catch (error) { console.error("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‚¨ãƒ©ãƒ¼:", error); }
        });
        
        // å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åç°¿(users)ã®å¤‰æ›´ã‚’ç›£è¦–
        function listenToUsers() {
            const usersRef = collection(db, "users");
            onSnapshot(usersRef, (snapshot) => {
                snapshot.docs.forEach(doc => { usersMap[doc.id] = doc.data(); });
                renderAllMessages(); // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒæ›´æ–°ã•ã‚ŒãŸã‚‰å†æç”»
            });
        }
        
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸(messages)ã®å¤‰æ›´ã‚’ç›£è¦– (channelId ã§çµã‚Šè¾¼ã‚€)
        function listenToMessages(channelId) {
            const q = query(
                collection(db, "messages"), 
                where("channelId", "==", channelId),
                orderBy("timestamp")
            );
            unsubscribeMessages = onSnapshot(q, (querySnapshot) => {
                currentMessages = querySnapshot.docs.map(doc => doc.data());
                renderAllMessages();
            });
        }
        
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¹ãƒˆã‚’ç”»é¢ã«æç”»ã™ã‚‹
        function renderAllMessages() {
            messageList.innerHTML = ''; 
            currentMessages.forEach(msg => {
                const senderInfo = usersMap[msg.senderId] || { displayName: 'ä¸æ˜ãªãƒ¦ãƒ¼ã‚¶ãƒ¼', photoURL: '' };
                displayMessage(senderInfo.displayName, senderInfo.photoURL, msg.text);
            });
            messageList.scrollTop = messageList.scrollHeight;
        }

        // --- 4. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºãƒ˜ãƒ«ãƒ‘ãƒ¼ (å¤‰æ›´ãªã—) ---
        
        function displayMessage(name, icon, text) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message';
            const safeText = text || '';
            const escapedText = safeText.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            const safeIcon = icon || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'; 
            msgDiv.innerHTML = `
                <img src="${safeIcon}" class="message-icon" alt="${name}">
                <div class="message-content">
                    <div class="message-sender">${name}</div>
                    <div class="message-text">${escapedText}</div>
                </div>
            `;
            messageList.appendChild(msgDiv);
        }
        
        // --- 5. ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å‡¦ç† (å¤‰æ›´ãªã—) ---
        
        settingsBtn.addEventListener('click', () => { profileModalOverlay.classList.remove('hidden'); });
        profileCancelBtn.addEventListener('click', () => { profileModalOverlay.classList.add('hidden'); });
        
        profileSaveBtn.addEventListener('click', async () => {
            const newName = profileNameInput.value.trim();
            const newIcon = profileIconInput.value.trim();
            if (newName === '' || newIcon === '') return alert('åå‰ã¨ã‚¢ã‚¤ã‚³ãƒ³URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            if (!currentUser) return;
            try {
                const userRef = doc(db, "users", currentUser.uid);
                await updateDoc(userRef, { displayName: newName, photoURL: newIcon });
                profileModalOverlay.classList.add('hidden');
            } catch (error) { console.error("ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–°ã‚¨ãƒ©ãƒ¼:", error); }
        });

    </script>
</body>
</html>