<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒ£ãƒƒãƒˆ (ãƒ¡ãƒ¼ãƒ«èªè¨¼å¯¾å¿œ)</title>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #36393f;
            color: #dcddde;
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ */
        #login-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8); display: flex;
            justify-content: center; align-items: center; z-index: 1000;
        }
        #login-box {
            background: #2f3136;
            padding: 30px;
            border-radius: 8px;
            width: 400px;
            box-sizing: border-box;
        }
        /* ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ */
        .login-tabs {
            display: flex;
            margin-bottom: 20px;
        }
        .login-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            border-bottom: 2px solid #40444b;
            color: #8e9297;
            font-weight: bold;
        }
        .login-tab.active {
            color: #fff;
            border-bottom-color: #5865f2;
        }
        /* ãƒ•ã‚©ãƒ¼ãƒ  */
        .login-form-group {
            margin-bottom: 15px;
        }
        .login-form-group label {
            display: block;
            margin-bottom: 5px;
            color: #b9bbbe;
            font-size: 0.9em;
        }
        .login-form-group input {
            width: 100%;
            padding: 10px;
            background: #202225;
            border: 1px solid #40444b;
            color: #dcddde;
            border-radius: 5px;
            box-sizing: border-box;
        }
        .login-btn {
            background: #5865f2;
            color: white;
            border: none;
            padding: 12px;
            font-size: 1em;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }
        /* Googleãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ */
        #google-login-btn {
            background: #fff;
            color: #747f8d;
            font-weight: bold;
        }
        #google-login-btn:before {
            content: 'G'; /* Googleã‚¢ã‚¤ã‚³ãƒ³ã®ä»£ã‚ã‚Š */
            color: #DB4437;
            margin-right: 10px;
            font-weight: bold;
        }
        /* åŒºåˆ‡ã‚Šç·š */
        .divider {
            text-align: center;
            color: #8e9297;
            margin: 20px 0;
            font-size: 0.9em;
        }
        /* ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        #login-error {
            color: #f04747;
            margin-top: 15px;
            text-align: center;
            font-size: 0.9em;
            min-height: 1.2em; /* ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºç”¨ã«é«˜ã•ã‚’ç¢ºä¿ */
        }

        /* --- ã“ã“ã‹ã‚‰ä¸‹ã¯ãƒãƒ£ãƒƒãƒˆç”»é¢ã®CSS --- */

        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
        #sidebar {
            width: 240px;
            background: #2f3136;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden; 
        }
        #sidebar-scroll-container {
            flex-grow: 1;
            overflow-y: auto; 
        }
        #channel-list-container {
            padding: 10px;
        }
        
        /* â˜…ãƒãƒ£ãƒ³ãƒãƒ«è¦‹å‡ºã— (é–‹é–‰æ©Ÿèƒ½)â˜… */
        #channel-list-container h3 {
            margin: 10px 5px 5px;
            color: #8e9297;
            font-size: 0.8em;
            text-transform: uppercase;
            cursor: pointer; /* â˜…ã‚¯ãƒªãƒƒã‚¯ã§ãã‚‹ã“ã¨ã‚’ç¤ºã™ */
            position: relative; /* â˜…çŸ¢å°ã®ãŸã‚ */
            padding-left: 15px; /* â˜…çŸ¢å°ã®ã‚¹ãƒšãƒ¼ã‚¹ */
        }
        /* â˜…çŸ¢å°ã®ã‚¹ã‚¿ã‚¤ãƒ«â˜… */
        #channel-list-container h3::before {
            content: 'â–¼'; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯é–‹ã„ã¦ã„ã‚‹çŸ¢å° */
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.8em;
            transition: transform 0.2s; /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        }
        /* â˜…é–‰ã˜ã¦ã„ã‚‹æ™‚ã®çŸ¢å°â˜… */
        #channel-list-container h3.collapsed::before {
            content: 'â–º';
        }
        
        .channel-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .channel-item {
            display: flex;
            align-items: center;
            padding: 8px 10px; border-radius: 5px;
            color: #8e9297; font-weight: 500;
        }
        .channel-item:hover { background: #3a3c43; color: #dcddde; }
        .channel-item.active { background: #40444b; color: #ffffff; }
        .channel-name {
            flex-grow: 1;
            cursor: pointer;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .channel-name .lock-icon { margin-right: 5px; color: #b9bbbe; }
        .delete-channel-btn {
            background: none; border: none; color: #b9bbbe;
            font-size: 1.1em; cursor: pointer; padding: 0 5px;
            margin-left: 5px; display: none; flex-shrink: 0;
        }
        .delete-channel-btn:hover { color: #f04747; }
        
        /* ãƒãƒ£ãƒ³ãƒãƒ«å‚åŠ /ä½œæˆãƒ•ã‚©ãƒ¼ãƒ  */
        .sidebar-form-container {
            padding: 10px;
            border-top: 1px solid #40444b;
        }
        .sidebar-form {
            display: flex; flex-direction: column; gap: 8px;
        }
        .sidebar-form input[type="text"] {
            background: #202225; border: none; color: #dcddde;
            padding: 8px; border-radius: 3px; font-size: 0.9em;
        }
        .sidebar-form button {
            background: #5865f2; color: white; border: none;
            padding: 8px; border-radius: 3px; cursor: pointer;
        }
        .checkbox-group {
            display: flex; align-items: center;
            font-size: 0.9em; color: #b9bbbe;
        }

        /* ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± (ã‚µã‚¤ãƒ‰ãƒãƒ¼ä¸‹éƒ¨) */
        #user-info-bar {
            background: #292b2f; padding: 10px; display: flex;
            align-items: center; flex-shrink: 0;
        }
        #user-info-bar img {
            width: 32px; height: 32px; border-radius: 50%; margin-right: 10px;
        }
        #user-info-bar span {
            font-size: 0.9em; font-weight: 500;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-grow: 1;
        }
        #settings-btn {
            background: none; border: none; color: #b9bbbe;
            font-size: 1.2em; cursor: pointer; margin-left: auto; padding: 5px; flex-shrink: 0;
        }
        #settings-btn:hover { color: #fff; }

        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
        #main-content {
            flex-grow: 1; display: flex; flex-direction: column; background: #36393f;
        }
        #main-header {
            padding: 20px; border-bottom: 1px solid #40444b;
            box-shadow: 0 1px 0 rgba(0,0,0,.2); font-size: 1.2em;
            font-weight: bold; color: #fff;
        }

        /* ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ */
        #message-list {
            flex-grow: 1; padding: 20px; overflow-y: auto;
        }
        .message { margin-bottom: 15px; display: flex; }
        .message-icon { width: 40px; height: 40px; border-radius: 50%; margin-right: 15px; flex-shrink: 0; }
        .message-content { padding-top: 5px; }
        .message-sender { font-weight: bold; color: #fff; margin-bottom: 5px; } 
        .message-text { line-height: 1.4; color: #dcddde; } 

        /* é€ä¿¡ãƒ•ã‚©ãƒ¼ãƒ  */
        #message-form {
            display: flex; padding: 20px; background: #40444b; align-items: center;
        }
        #message-input {
            flex-grow: 1; background: #484c52; border: none;
            border-radius: 8px; padding: 10px 15px;
            color: #dcddde; font-size: 1em; outline: none;
        }
        
        /* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« */
        #profile-modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8); display: flex;
            justify-content: center; align-items: center; z-index: 2000;
        }
        #profile-modal { background: #2f3136; padding: 30px; border-radius: 8px; width: 400px; }
        #profile-modal h2 { margin-top: 0; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; color: #b9bbbe; }
        .form-group input { width: 100%; padding: 10px; background: #202225; border: 1px solid #40444b; color: #dcddde; border-radius: 5px; box-sizing: border-box; }
        .modal-buttons { display: flex; justify-content: flex-end; margin-top: 20px; }
        .modal-buttons button { border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; margin-left: 10px; }
        #profile-cancel-btn { background: #747f8d; color: white; }
        #profile-save-btn { background: #5865f2; color: white; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div id="login-box">
            <div class="login-tabs">
                <div class="login-tab active" data-tab="login">ãƒ­ã‚°ã‚¤ãƒ³</div>
                <div class="login-tab" data-tab="register">æ–°è¦ç™»éŒ²</div>
            </div>

            <form id="login-form">
                <div class="login-form-group">
                    <label for="login-email">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                    <input type="email" id="login-email" required>
                </div>
                <div class="login-form-group">
                    <label for="login-password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                    <input type="password" id="login-password" required>
                </div>
                <button type="submit" class="login-btn">ãƒ­ã‚°ã‚¤ãƒ³</button>
            </form>
            
            <form id="register-form" class="hidden">
                <div class="login-form-group">
                    <label for="register-name">è¡¨ç¤ºå</label>
                    <input type="text" id="register-name" required>
                </div>
                <div class="login-form-group">
                    <label for="register-email">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                    <input type="email" id="register-email" required>
                </div>
                <div class="login-form-group">
                    <label for="register-password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ6æ–‡å­—ä»¥ä¸Šï¼‰</label>
                    <input type="password" id="register-password" required>
                </div>
                <button type="submit" class="login-btn">ç™»éŒ²ã™ã‚‹</button>
            </form>

            <div class="divider">ã¾ãŸã¯</div>
            
            <button id="google-login-btn" class="login-btn">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
            
            <p id="login-error"></p>
        </div>
    </div>

    <div id="sidebar" class="hidden"> <div id="sidebar-scroll-container">
            <div id="channel-list-container">
                <h3>å…¬é–‹ãƒãƒ£ãƒ³ãƒãƒ«</h3>
                <ul id="public-channel-list" class="channel-list"></ul>
                <h3>ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒãƒ£ãƒ³ãƒãƒ«</h3>
                <ul id="private-channel-list" class="channel-list"></ul>
            </div>
            <div class="sidebar-form-container">
                <form id="join-private-form" class="sidebar-form">
                    <input type="text" id="join-id-input" placeholder="å‚åŠ IDï¼ˆåˆè¨€è‘‰ï¼‰" autocomplete="off" required>
                    <button type="submit">IDã§ãƒãƒ£ãƒ³ãƒãƒ«ã«å‚åŠ </button>
                </form>
                <hr style="border-color: #40444b; margin: 15px 0;">
                <form id="add-channel-form" class="sidebar-form">
                    <input type="text" id="add-channel-input" placeholder="æ–°ã—ã„ãƒãƒ£ãƒ³ãƒãƒ«å" autocomplete="off" required>
                    <input type="text" id="secret-id-input" placeholder="IDï¼ˆåˆè¨€è‘‰ï¼‰ã‚’è¨­å®š" autocomplete="off" class="hidden">
                    <div class="checkbox-group">
                        <input type="checkbox" id="is-private-checkbox">
                        <label for="is-private-checkbox" style="margin-left: 5px;">IDä»˜ãï¼ˆéå…¬é–‹ï¼‰ã«ã™ã‚‹</label>
                    </div>
                    <button type="submit">ãƒãƒ£ãƒ³ãƒãƒ«ä½œæˆ</button>
                </form>
            </div>
        </div> 
        <div id="user-info-bar">
            <img id="user-icon" src="" alt="icon">
            <span id="user-name"></span>
            <button id="settings-btn" title="ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®š">âš™ï¸</button>
        </div>
    </div>

    <div id="main-content" class="hidden"> <div id="main-header">#<span id="current-channel-name">general</span></div>
        <div id="message-list"></div>
        <form id="message-form">
            <input type="text" id="message-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡..." autocomplete="off">
        </form>
    </div>
    
    <div id="profile-modal-overlay" class="hidden">
        <div id="profile-modal">
            <h2>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ç·¨é›†</h2>
            <div class="form-group">
                <label for="profile-name-input">è¡¨ç¤ºå</label>
                <input type="text" id="profile-name-input">
            </div>
            <div class="form-group">
                <label for="profile-icon-input">ã‚¢ã‚¤ã‚³ãƒ³URL</label>
                <input type="text" id="profile-icon-input" placeholder="https://example.com/image.png">
            </div>
            <div class="modal-buttons">
                <button id="profile-cancel-btn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="profile-save-btn">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase SDK ã®ã‚³ã‚¢ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        // èªè¨¼ (Auth) ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        import { 
            getAuth, 
            GoogleAuthProvider, 
            signInWithPopup, 
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword
        } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        // Firestore ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        import { 
            getFirestore, collection, addDoc, query, orderBy, onSnapshot, 
            serverTimestamp, doc, setDoc, updateDoc, getDoc, where,
            arrayUnion, deleteDoc,
            getDocs // â˜…ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä¸è¦ã®æ¤œç´¢(getDocs)ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // â˜…â˜…â˜… ã‚ãªãŸã®Firebaseè¨­å®š (çµ„ã¿è¾¼ã¿æ¸ˆã¿) â˜…â˜…â˜…
        const firebaseConfig = {
          apiKey: "AIzaSyAhXs223e-Shn8JfnvNC1IS4-T33mtKd-k",
          authDomain: "sexsex-90a07.firebaseapp.com",
          projectId: "sexsex-90a07",
          storageBucket: "sexsex-90a07.appspot.com",
          messagingSenderId: "252347983312",
          appId: "1:252347983312:web:89019e1ee68879839385d5"
        };
        // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…

        // Firebase ã‚¢ãƒ—ãƒªã‚’åˆæœŸåŒ–
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // --- 0. â˜…ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ã¨ åˆæœŸã‚¢ã‚¤ã‚³ãƒ³â˜… ---
        
        // â˜…â˜…â˜… (ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¿®æ­£) â˜…â˜…â˜…
        // â˜…ã”è¦æœ›ã®ã€ŒåŒ¿åã®äººã®ã‚¢ã‚¤ã‚³ãƒ³ã€ã®URLã§ã™â˜…
        const defaultIcon = 'https://i.imgur.com/B1Q1hL1.png';
        // â˜…â˜…â˜… (ä¿®æ­£ã“ã“ã¾ã§) â˜…â˜…â˜…

        // DOMè¦ç´ ã®å–å¾— (ãƒ­ã‚°ã‚¤ãƒ³é–¢é€£)
        const loginOverlay = document.getElementById('login-overlay');
        const loginTabs = document.querySelectorAll('.login-tab');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const loginError = document.getElementById('login-error');
        const googleLoginBtn = document.getElementById('google-login-btn');
        
        // DOMè¦ç´ ã®å–å¾— (ãƒãƒ£ãƒƒãƒˆé–¢é€£)
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('main-content');
        const userInfoBar = document.getElementById('user-info-bar');
        const userIcon = document.getElementById('user-icon');
        const userName = document.getElementById('user-name');
        const messageList = document.getElementById('message-list');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const publicChannelList = document.getElementById('public-channel-list');
        const privateChannelList = document.getElementById('private-channel-list');
        const addChannelForm = document.getElementById('add-channel-form');
        const addChannelInput = document.getElementById('add-channel-input');
        const isPrivateCheckbox = document.getElementById('is-private-checkbox');
        const secretIdInput = document.getElementById('secret-id-input'); 
        const joinPrivateForm = document.getElementById('join-private-form');
        const joinIdInput = document.getElementById('join-id-input');
        const currentChannelName = document.getElementById('current-channel-name');
        const settingsBtn = document.getElementById('settings-btn');
        const profileModalOverlay = document.getElementById('profile-modal-overlay');
        const profileNameInput = document.getElementById('profile-name-input');
        const profileIconInput = document.getElementById('profile-icon-input');
        const profileCancelBtn = document.getElementById('profile-cancel-btn');
        const profileSaveBtn = document.getElementById('profile-save-btn');
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentUser = null;
        let usersMap = {}; 
        let currentMessages = [];
        let currentChannelId = 'general'; 
        let unsubscribeMessages = null; 
        let unsubscribeMyProfile = null; 
        
        
        // --- 1. èªè¨¼ (ãƒ­ã‚°ã‚¤ãƒ³) å‡¦ç† ---

        // â˜…ãƒ­ã‚°ã‚¤ãƒ³/æ–°è¦ç™»éŒ²ã®ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        loginTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                loginTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                const activeTab = tab.dataset.tab;
                loginForm.classList.toggle('hidden', activeTab !== 'login');
                registerForm.classList.toggle('hidden', activeTab !== 'register');
                loginError.textContent = ''; // ã‚¨ãƒ©ãƒ¼ã‚’ã‚¯ãƒªã‚¢
            });
        });
        
        // â˜…Googleãƒ­ã‚°ã‚¤ãƒ³
        googleLoginBtn.addEventListener('click', async () => {
            loginError.textContent = '';
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                loginError.textContent = getAuthErrorMessage(error.code);
            }
        });
        
        // â˜…ãƒ¡ãƒ¼ãƒ«ã§ã€Œãƒ­ã‚°ã‚¤ãƒ³ã€
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loginError.textContent = '';
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                loginError.textContent = getAuthErrorMessage(error.code);
            }
        });
        
        // â˜…ãƒ¡ãƒ¼ãƒ«ã§ã€Œæ–°è¦ç™»éŒ²ã€ (â˜…è¡¨ç¤ºåã‚‚ä¿å­˜â˜…)
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loginError.textContent = '';
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const displayName = document.getElementById('register-name').value.trim(); // â˜…è¡¨ç¤ºåã‚’å–å¾—â˜…
            
            if (displayName === '') {
                loginError.textContent = 'è¡¨ç¤ºåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
                return;
            }
            
            try {
                // 1. Authã‚µãƒ¼ãƒ“ã‚¹ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆ
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // 2. â˜…Firestoreã® 'users' åç°¿ã«ã€æ‰‹å‹•ã§ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ç™»éŒ²â˜…
                await setDoc(doc(db, "users", user.uid), {
                    displayName: displayName, // â˜…ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰å–å¾—ã—ãŸè¡¨ç¤ºå
                    photoURL: defaultIcon, // â˜…åŒ¿åã®äººã®ã‚¢ã‚¤ã‚³ãƒ³â˜…
                    joinedPrivateChannels: []
                });
                
            } catch (error) {
                loginError.textContent = getAuthErrorMessage(error.code);
            }
        });

        // â˜…èªè¨¼çŠ¶æ…‹ã®ç›£è¦– (ãƒ­ã‚°ã‚¤ãƒ³/ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚’æ¤œçŸ¥)
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ
                currentUser = user;
                loginOverlay.classList.add('hidden'); 
                sidebar.classList.remove('hidden'); // â˜…ãƒãƒ£ãƒƒãƒˆUIã‚’è¡¨ç¤º
                mainContent.classList.remove('hidden'); // â˜…ãƒãƒ£ãƒƒãƒˆUIã‚’è¡¨ç¤º
                
                await setupUserProfile(user); 
                
                listenToUsers(); 
                listenToPublicChannels(); 
                listenToMyProfileAndPrivateChannels(user.uid); 
                
                switchChannel('general', 'general');
                
            } else {
                // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆçŠ¶æ…‹
                currentUser = null;
                loginOverlay.classList.remove('hidden'); 
                sidebar.classList.add('hidden'); // â˜…ãƒãƒ£ãƒƒãƒˆUIã‚’éš ã™
                mainContent.classList.add('hidden'); // â˜…ãƒãƒ£ãƒƒãƒˆUIã‚’éš ã™
                
                messageList.innerHTML = ''; 
                publicChannelList.innerHTML = '';
                privateChannelList.innerHTML = '';
                
                if (unsubscribeMessages) unsubscribeMessages();
                if (unsubscribeMyProfile) unsubscribeMyProfile();
            }
        });
        
        // â˜…ãƒ¦ãƒ¼ã‚¶ãƒ¼åç°¿(users)ã‚’æº–å‚™ã™ã‚‹é–¢æ•°
        async function setupUserProfile(user) {
            const userRef = doc(db, "users", user.uid);
            const userDoc = await getDoc(userRef);
            
            if (!userDoc.exists()) {
                // â˜…ä¸»ã«ã€ŒGoogleãƒ­ã‚°ã‚¤ãƒ³ã€ã®åˆå›æ™‚ã«å®Ÿè¡Œã•ã‚Œã‚‹â˜…
                await setDoc(userRef, {
                    displayName: user.displayName || 'åç„¡ã—ã•ã‚“', // Googleå
                    photoURL: user.photoURL || defaultIcon, // â˜…Googleã‚¢ã‚¤ã‚³ãƒ³(ç„¡ã‘ã‚Œã°åŒ¿å)â˜…
                    joinedPrivateChannels: []
                });
            }
        }
        
        // â˜…èªè¨¼ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ—¥æœ¬èªã«å¤‰æ›ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
        function getAuthErrorMessage(code) {
            switch (code) {
                case 'auth/invalid-email':
                    return 'ç„¡åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã™ã€‚';
                case 'auth/user-not-found':
                    return 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚';
                case 'auth/wrong-password':
                    return 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™ã€‚';
                case 'auth/email-already-in-use':
                    return 'ãã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚';
                case 'auth/weak-password':
                    return 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§è¨­å®šã—ã¦ãã ã•ã„ã€‚';
                case 'auth/operation-not-allowed':
                    return 'Firebaseå´ã§ãƒ­ã‚°ã‚¤ãƒ³æ–¹æ³•ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã¾ã›ã‚“ã€‚';
                default:
                    return 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + code;
            }
        }

        // --- 2. ãƒãƒ£ãƒ³ãƒãƒ«å‡¦ç† ---
        
        // â˜…ãƒãƒ£ãƒ³ãƒãƒ«ãƒªã‚¹ãƒˆã®é–‹é–‰ï¼ˆã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ï¼‰æ©Ÿèƒ½â˜…
        const channelHeaders = document.querySelectorAll('#channel-list-container h3');
        channelHeaders.forEach(header => {
            header.addEventListener('click', () => {
                header.classList.toggle('collapsed');
                const list = header.nextElementSibling;
                if (list && list.classList.contains('channel-list')) {
                    list.classList.toggle('hidden');
                }
            });
        });

        // â˜…è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã¨ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆCHã‚’ç›£è¦–ã™ã‚‹
        function listenToMyProfileAndPrivateChannels(uid) {
            const userRef = doc(db, "users", uid);
            
            if (unsubscribeMyProfile) unsubscribeMyProfile();
            
            unsubscribeMyProfile = onSnapshot(userRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’æ›´æ–°
                    userIcon.src = data.photoURL || defaultIcon; // â˜…åŒ¿åã®äººã®ã‚¢ã‚¤ã‚³ãƒ³â˜…
                    userName.textContent = data.displayName;
                    profileNameInput.value = data.displayName;
                    profileIconInput.value = data.photoURL;
                    
                    // â˜…ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆCHã®ãƒªã‚¹ãƒˆã‚’æç”»ã—ç›´ã™â˜…
                    renderPrivateChannels(data.joinedPrivateChannels || []);
                }
            });
        }
        
        // â˜…â˜…â˜… (ãƒã‚°ä¿®æ­£ 1/2) â˜…â˜…â˜…
        // â˜…ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆCHã‚’æç”»ã™ã‚‹é–¢æ•° (ç«¶åˆçŠ¶æ…‹ãƒã‚°ã‚’ä¿®æ­£)â˜…
        async function renderPrivateChannels(idArray) {
            
            // 1. ç¾åœ¨HTMLã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹IDã®ã‚»ãƒƒãƒˆã‚’ä½œæˆ
            const existingIdsOnPage = new Set();
            privateChannelList.querySelectorAll('.channel-item').forEach(el => {
                existingIdsOnPage.add(el.dataset.id);
            });

            // 2. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒªã‚¹ãƒˆ (idArray) ã«ã¯ã‚‚ã†ç„¡ã„ã®ã«ã€HTMLã«æ®‹ã£ã¦ã„ã‚‹ã‚‚ã®ã‚’å‰Šé™¤
            privateChannelList.querySelectorAll('.channel-item').forEach(el => {
                if (!idArray.includes(el.dataset.id)) {
                    el.remove();
                }
            });

            // 3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒªã‚¹ãƒˆ (idArray) ã«ã¯æœ‰ã‚‹ã®ã«ã€HTMLã«ã¾ã ç„¡ã„ã‚‚ã®ã‚’è¿½åŠ 
            for (const id of idArray) {
                if (!existingIdsOnPage.has(id)) {
                    // â˜…ã“ã‚Œã¯æ–°ã—ã„IDãªã®ã§ã€DBã‹ã‚‰æƒ…å ±ã‚’å–ã£ã¦ãã¦è¿½åŠ ã™ã‚‹
                    try { 
                        const channelDoc = await getDoc(doc(db, "channels", id));
                        if (channelDoc.exists()) {
                            const channel = channelDoc.data();
                            const li = createChannelElement(channelDoc.id, channel.name, true, channel.ownerId); 
                            privateChannelList.appendChild(li); // â˜…ãƒªã‚¹ãƒˆã®æœ€å¾Œã«ã€Œè¿½åŠ ã€ã™ã‚‹
                        }
                    } catch(e) { 
                        // (ç«¶åˆçŠ¶æ…‹ãªã©ã§å¤±æ•—ã—ã¦ã‚‚ã€æ¬¡ã®onSnapshotã§ãƒªãƒˆãƒ©ã‚¤ã•ã‚Œã‚‹ã®ã§OK)
                        console.warn("ãƒãƒ£ãƒ³ãƒãƒ«ã®å–å¾—ã«å¤±æ•— (ç«¶åˆã‹ã‚‚):", id, e.message); 
                    }
                }
            }
        }
        // â˜…â˜…â˜… (ä¿®æ­£ã“ã“ã¾ã§ 1/2) â˜…â˜…â˜…

        
        // â˜…å…¬é–‹ãƒãƒ£ãƒ³ãƒãƒ«ã®ä¸¦ã³æ›¿ãˆ (ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä¸è¦ç‰ˆ)
        function listenToPublicChannels() {
            const q = query(collection(db, "channels"), where("secretId", "==", null));
            
            onSnapshot(q, (snapshot) => {
                publicChannelList.innerHTML = ''; 
                
                const channels = [];
                snapshot.forEach((doc) => {
                    channels.push({ id: doc.id, data: doc.data() });
                });

                // â˜…JSå´ã§åå‰é † (a-z) ã«ã‚½ãƒ¼ãƒˆã™ã‚‹â˜…
                channels.sort((a, b) => a.data.name.localeCompare(b.data.name));
                
                if (channels.length === 0) {
                     addDoc(collection(db, "channels"), { 
                        name: "general", 
                        secretId: null, 
                        ownerId: "system" 
                    });
                } else {
                    channels.forEach((channel) => {
                        const li = createChannelElement(channel.id, channel.data.name, false, channel.data.ownerId); 
                        publicChannelList.appendChild(li);
                    });
                }
            }, (error) => { 
                console.error("å…¬é–‹ãƒãƒ£ãƒ³ãƒãƒ«ã®ç›£è¦–ã‚¨ãƒ©ãƒ¼:", error);
            });
        }
        
        // ãƒãƒ£ãƒ³ãƒãƒ«ã®HTMLè¦ç´ ã‚’ä½œæˆ (å¤‰æ›´ãªã—)
        function createChannelElement(id, name, isPrivate, ownerId) {
            const li = document.createElement('li');
            li.className = 'channel-item';
            li.dataset.id = id; 
            const nameSpan = document.createElement('span');
            nameSpan.className = 'channel-name';
            nameSpan.innerHTML = `${isPrivate ? '<span class="lock-icon">ğŸ”’</span> ' : '# '} ${name}`;
            nameSpan.addEventListener('click', () => {
                switchChannel(id, name);
            });
            li.appendChild(nameSpan);
            if (ownerId === currentUser.uid && id !== 'general') { 
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-channel-btn';
                deleteBtn.innerHTML = 'ğŸ—‘ï¸';
                deleteBtn.title = 'ãƒãƒ£ãƒ³ãƒãƒ«ã‚’å‰Šé™¤';
                deleteBtn.style.display = 'inline-block'; 
                deleteBtn.addEventListener('click', async (e) => {
                    e.stopPropagation(); 
                    if (confirm(`ãƒãƒ£ãƒ³ãƒãƒ«ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                        try {
                            await deleteDoc(doc(db, "channels", id));
                            if (id === currentChannelId) {
                                switchChannel('general', 'general');
                            }
                        } catch (error) {
                            console.error("ãƒãƒ£ãƒ³ãƒãƒ«å‰Šé™¤ã‚¨ãƒ©ãƒ¼:", error);
                        }
                    }
                });
                li.appendChild(deleteBtn);
            }
            if (id === currentChannelId) li.classList.add('active');
            return li;
        }
        
        // â˜…ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆCHä½œæˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å‡¦ç†â˜…
        isPrivateCheckbox.addEventListener('change', () => {
            secretIdInput.classList.toggle('hidden', !isPrivateCheckbox.checked);
            secretIdInput.required = isPrivateCheckbox.checked;
        });

        // â˜…ãƒãƒ£ãƒ³ãƒãƒ«ä½œæˆãƒ•ã‚©ãƒ¼ãƒ ã®å‡¦ç† (å…¬é–‹CHã‚‚è‡ªå‹•é¸æŠã™ã‚‹)
        addChannelForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const channelName = addChannelInput.value.trim();
            if (channelName === '' || !currentUser) return;
            const newChannelData = {
                name: channelName,
                secretId: null,
                ownerId: currentUser.uid
            };
            if (isPrivateCheckbox.checked) {
                const secretId = secretIdInput.value.trim();
                if (secretId === '') {
                    alert('IDï¼ˆåˆè¨€è‘‰ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    return; 
                }
                newChannelData.secretId = secretId;
            }
            try {
                const docRef = await addDoc(collection(db, "channels"), newChannelData);
                
                if (newChannelData.secretId !== null) {
                    // ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆCHã®å ´åˆï¼šè‡ªåˆ†ã‚’å‚åŠ ã•ã›ã€åˆ‡ã‚Šæ›¿ãˆã‚‹
                    const userRef = doc(db, "users", currentUser.uid);
                    await updateDoc(userRef, { joinedPrivateChannels: arrayUnion(docRef.id) });
                    // â˜…â†‘ã“ã® updateDoc ãŒã€onSnapshot(userRef) ã‚’ç™ºç«ã•ã›ã€è‡ªå‹•ã§ãƒªã‚¹ãƒˆãŒæ›´æ–°ã•ã‚Œã‚‹â˜…
                    switchChannel(docRef.id, newChannelData.name);
                } else {
                    // â˜…å…¬é–‹CHã®å ´åˆï¼šã™ãã«ãƒãƒ£ãƒ³ãƒãƒ«ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹â˜…
                    switchChannel(docRef.id, newChannelData.name);
                }
                
                addChannelInput.value = '';
                secretIdInput.value = '';
                isPrivateCheckbox.checked = false;
                secretIdInput.classList.add('hidden');
                secretIdInput.required = false; 
            } catch (error) { console.error("ãƒãƒ£ãƒ³ãƒãƒ«è¿½åŠ ã‚¨ãƒ©ãƒ¼:", error); }
        });
        
        // â˜…â˜…â˜… (ãƒã‚°ä¿®æ­£ 2/2) â˜…â˜…â˜…
        // â˜…IDã§å‚åŠ ã™ã‚‹ãƒ•ã‚©ãƒ¼ãƒ  (ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä¸è¦ç‰ˆ)
        joinPrivateForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const secretId = joinIdInput.value.trim();
            if (secretId === '' || !currentUser) return;
            
            try {
                // 1. â˜…ã€Œãƒãƒ£ãƒ³ãƒãƒ«å…¨éƒ¨ã€ã‚’å–å¾—ã™ã‚‹ (ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä¸è¦)
                const allChannelsQuery = query(collection(db, "channels"));
                const snapshot = await getDocs(allChannelsQuery);
                
                let foundDoc = null;
                
                // 2. â˜…æ‰‹å…ƒ (JS) ã§ã€åˆè¨€è‘‰ (secretId) ãŒä¸€è‡´ã™ã‚‹ã‚‚ã®ã‚’æ¢ã™
                snapshot.forEach((doc) => {
                    if (doc.data().secretId === secretId) {
                        foundDoc = doc;
                    }
                });

                // 3. çµæœã‚’å‡¦ç†
                if (foundDoc === null) {
                    alert('IDï¼ˆåˆè¨€è‘‰ï¼‰ãŒé–“é•ã£ã¦ã„ã‚‹ã‹ã€ãƒãƒ£ãƒ³ãƒãƒ«ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚');
                } else {
                    // è¦‹ã¤ã‹ã£ãŸï¼
                    const userRef = doc(db, "users", currentUser.uid);
                    // è‡ªåˆ†ã‚’ãã®CHã®å‚åŠ è€…ãƒªã‚¹ãƒˆã«è¿½åŠ 
                    await updateDoc(userRef, { joinedPrivateChannels: arrayUnion(foundDoc.id) });
                    // â˜…â†‘ã“ã® updateDoc ãŒã€onSnapshot(userRef) ã‚’ç™ºç«ã•ã›ã€è‡ªå‹•ã§ãƒªã‚¹ãƒˆãŒæ›´æ–°ã•ã‚Œã‚‹â˜…
                    
                    // ãã®CHã«åˆ‡ã‚Šæ›¿ãˆã‚‹
                    switchChannel(foundDoc.id, foundDoc.data().name);
                    joinIdInput.value = '';
                }
            } catch (error) {
                console.error("IDå‚åŠ ã‚¨ãƒ©ãƒ¼:", error);
                alert("ãƒãƒ£ãƒ³ãƒãƒ«ã®æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
            }
        });
        // â˜…â˜…â˜… (ä¿®æ­£ã“ã“ã¾ã§ 2/2) â˜…â˜…â˜…

        
        // ãƒãƒ£ãƒ³ãƒãƒ«åˆ‡ã‚Šæ›¿ãˆ
        function switchChannel(channelId, channelName) {
            if (unsubscribeMessages) unsubscribeMessages();
            currentChannelId = channelId; 
            currentChannelName.textContent = channelName; 
            document.querySelectorAll('.channel-item').forEach(el => {
                el.classList.toggle('active', el.dataset.id === channelId);
            });
            listenToMessages(channelId);
        }

        // --- 3. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€å—ä¿¡å‡¦ç† ---
        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault(); 
            const text = messageInput.value.trim();
            if (text === '' || !currentUser) return; 
            try {
                await addDoc(collection(db, "messages"), {
                    senderId: currentUser.uid, 
                    channelId: currentChannelId, 
                    timestamp: serverTimestamp(),
                    text: text 
                });
                messageInput.value = ''; 
            } catch (error) { 
                console.error("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‚¨ãƒ©ãƒ¼:", error); 
                alert("é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
            }
        });
        function listenToUsers() {
            const usersRef = collection(db, "users");
            onSnapshot(usersRef, (snapshot) => {
                snapshot.docs.forEach(doc => { usersMap[doc.id] = doc.data(); });
                renderAllMessages(); 
            }, (error) => { 
                console.error("ãƒ¦ãƒ¼ã‚¶ãƒ¼ç›£è¦–ã‚¨ãƒ©ãƒ¼:", error);
            });
        }
        
        // â˜…ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä¸¦ã³æ›¿ãˆ (ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä¸è¦ç‰ˆ)
        function listenToMessages(channelId) {
            const q = query(
                collection(db, "messages"), 
                where("channelId", "==", channelId)
            );
            unsubscribeMessages = onSnapshot(q, (querySnapshot) => {
                currentMessages = querySnapshot.docs.map(doc => doc.data());
                
                // â˜…JSå´ã§æ™‚é–“é † (å¤ã„â†’æ–°ã—ã„) ã«ã‚½ãƒ¼ãƒˆã™ã‚‹â˜…
                currentMessages.sort((a, b) => {
                    const timeA = a.timestamp ? a.timestamp.toMillis() : 0;
                    const timeB = b.timestamp ? b.timestamp.toMillis() : 0;
                    return timeA - timeB;
                });
                
                renderAllMessages();
            }, (error) => { 
                console.error("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç›£è¦–ã‚¨ãƒ©ãƒ¼:", error);
            });
        }
        
        function renderAllMessages() {
            messageList.innerHTML = ''; 
            currentMessages.forEach(msgData => { 
                const senderInfo = usersMap[msgData.senderId] || { displayName: 'ä¸æ˜ãªãƒ¦ãƒ¼ã‚¶ãƒ¼', photoURL: defaultIcon };
                displayMessage(senderInfo.displayName, senderInfo.photoURL, msgData.text);
            });
            messageList.scrollTop = messageList.scrollHeight;
        }

        // --- 4. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºãƒ˜ãƒ«ãƒ‘ãƒ¼ ---
        function displayMessage(name, icon, text) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message';
            const safeIcon = icon || defaultIcon; // â˜…åŒ¿åã®äººã®ã‚¢ã‚¤ã‚³ãƒ³â˜…
            const safeText = text || ''; 
            const escapedText = safeText.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            const messageBodyHTML = `<div class="message-text">${escapedText}</div>`;
            
            msgDiv.innerHTML = `
                <img src="${safeIcon}" class="message-icon" alt="${name}">
                <div class="message-content">
                    <div class="message-sender">${name}</div>
                    ${messageBodyHTML}
                </div>
            `;
            messageList.appendChild(msgDiv);
        }
        
        // --- 5. ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« ---
        settingsBtn.addEventListener('click', () => { profileModalOverlay.classList.remove('hidden'); });
        profileCancelBtn.addEventListener('click', () => { profileModalOverlay.classList.add('hidden'); });
        profileSaveBtn.addEventListener('click', async () => {
            const newName = profileNameInput.value.trim();
            let newIcon = profileIconInput.value.trim();
            if (newName === '') return alert('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            if (newIcon === '') newIcon = defaultIcon; // â˜…åŒ¿åã®äººã®ã‚¢ã‚¤ã‚³ãƒ³â˜…
            if (!currentUser) return;
            try {
                const userRef = doc(db, "users", currentUser.uid);
                await updateDoc(userRef, { displayName: newName, photoURL: newIcon });
                profileModalOverlay.classList.add('hidden');
            } catch (error) { console.error("ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–°ã‚¨ãƒ©ãƒ¼:", error); }
        });

    </script>
</body>
</html>
