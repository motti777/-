<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„É™„Ç¢„É´„Çø„Ç§„É†„ÉÅ„É£„ÉÉ„Éà („É°„Éº„É´Ë™çË®ºÂØæÂøú)</title>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #36393f;
            color: #dcddde;
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* „É≠„Ç∞„Ç§„É≥ÁîªÈù¢ */
        #login-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8); display: flex;
            justify-content: center; align-items: center; z-index: 1000;
        }
        #login-box {
            background: #2f3136;
            padding: 30px;
            border-radius: 8px;
            width: 400px;
            box-sizing: border-box;
        }
        /* „Çø„ÉñÂàá„ÇäÊõø„Åà */
        .login-tabs {
            display: flex;
            margin-bottom: 20px;
        }
        .login-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            border-bottom: 2px solid #40444b;
            color: #8e9297;
            font-weight: bold;
        }
        .login-tab.active {
            color: #fff;
            border-bottom-color: #5865f2;
        }
        /* „Éï„Ç©„Éº„É† */
        .login-form-group {
            margin-bottom: 15px;
        }
        .login-form-group label {
            display: block;
            margin-bottom: 5px;
            color: #b9bbbe;
            font-size: 0.9em;
        }
        .login-form-group input {
            width: 100%;
            padding: 10px;
            background: #202225;
            border: 1px solid #40444b;
            color: #dcddde;
            border-radius: 5px;
            box-sizing: border-box;
        }
        .login-btn {
            background: #5865f2;
            color: white;
            border: none;
            padding: 12px;
            font-size: 1em;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }
        /* Google„É≠„Ç∞„Ç§„É≥„Éú„Çø„É≥ */
        #google-login-btn {
            background: #fff;
            color: #747f8d;
            font-weight: bold;
        }
        #google-login-btn:before {
            content: 'G'; /* Google„Ç¢„Ç§„Ç≥„É≥„ÅÆ‰ª£„Çè„Çä */
            color: #DB4437;
            margin-right: 10px;
            font-weight: bold;
        }
        /* Âå∫Âàá„ÇäÁ∑ö */
        .divider {
            text-align: center;
            color: #8e9297;
            margin: 20px 0;
            font-size: 0.9em;
        }
        /* „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏ */
        #login-error {
            color: #f04747;
            margin-top: 15px;
            text-align: center;
            font-size: 0.9em;
            min-height: 1.2em; /* „Ç®„É©„ÉºË°®Á§∫Áî®„Å´È´ò„Åï„ÇíÁ¢∫‰øù */
        }

        /* --- „Åì„Åì„Åã„Çâ‰∏ã„ÅØÂ§âÊõ¥„Å™„Åó („ÉÅ„É£„ÉÉ„ÉàÁîªÈù¢„ÅÆCSS) --- */

        /* „Çµ„Ç§„Éâ„Éê„Éº */
        #sidebar {
            width: 240px;
            background: #2f3136;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden; 
        }
        #sidebar-scroll-container {
            flex-grow: 1;
            overflow-y: auto; 
        }
        #channel-list-container {
            padding: 10px;
        }
        #channel-list-container h3 {
            margin: 10px 5px 5px;
            color: #8e9297;
            font-size: 0.8em;
            text-transform: uppercase;
        }
        .channel-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .channel-item {
            display: flex;
            align-items: center;
            padding: 8px 10px; border-radius: 5px;
            color: #8e9297; font-weight: 500;
        }
        .channel-item:hover { background: #3a3c43; color: #dcddde; }
        .channel-item.active { background: #40444b; color: #ffffff; }
        .channel-name {
            flex-grow: 1;
            cursor: pointer;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .channel-name .lock-icon { margin-right: 5px; color: #b9bbbe; }
        .delete-channel-btn {
            background: none; border: none; color: #b9bbbe;
            font-size: 1.1em; cursor: pointer; padding: 0 5px;
            margin-left: 5px; display: none; flex-shrink: 0;
        }
        .delete-channel-btn:hover { color: #f04747; }
        
        /* „ÉÅ„É£„É≥„Éç„É´ÂèÇÂä†/‰ΩúÊàê„Éï„Ç©„Éº„É† */
        .sidebar-form-container {
            padding: 10px;
            border-top: 1px solid #40444b;
        }
        .sidebar-form {
            display: flex; flex-direction: column; gap: 8px;
        }
        .sidebar-form input[type="text"] {
            background: #202225; border: none; color: #dcddde;
            padding: 8px; border-radius: 3px; font-size: 0.9em;
        }
        .sidebar-form button {
            background: #5865f2; color: white; border: none;
            padding: 8px; border-radius: 3px; cursor: pointer;
        }
        .checkbox-group {
            display: flex; align-items: center;
            font-size: 0.9em; color: #b9bbbe;
        }

        /* „É¶„Éº„Ç∂„ÉºÊÉÖÂ†± („Çµ„Ç§„Éâ„Éê„Éº‰∏ãÈÉ®) */
        #user-info-bar {
            background: #292b2f; padding: 10px; display: flex;
            align-items: center; flex-shrink: 0;
        }
        #user-info-bar img {
            width: 32px; height: 32px; border-radius: 50%; margin-right: 10px;
        }
        #user-info-bar span {
            font-size: 0.9em; font-weight: 500;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-grow: 1;
        }
        #settings-btn {
            background: none; border: none; color: #b9bbbe;
            font-size: 1.2em; cursor: pointer; margin-left: auto; padding: 5px; flex-shrink: 0;
        }
        #settings-btn:hover { color: #fff; }

        /* „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ */
        #main-content {
            flex-grow: 1; display: flex; flex-direction: column; background: #36393f;
        }
        #main-header {
            padding: 20px; border-bottom: 1px solid #40444b;
            box-shadow: 0 1px 0 rgba(0,0,0,.2); font-size: 1.2em;
            font-weight: bold; color: #fff;
        }

        /* „ÉÅ„É£„ÉÉ„Éà„Ç®„É™„Ç¢ */
        #message-list {
            flex-grow: 1; padding: 20px; overflow-y: auto;
        }
        .message { margin-bottom: 15px; display: flex; }
        .message-icon { width: 40px; height: 40px; border-radius: 50%; margin-right: 15px; flex-shrink: 0; }
        .message-content { padding-top: 5px; }
        .message-sender { font-weight: bold; color: #fff; margin-bottom: 5px; }
        .message-text { line-height: 1.4; color: #dcddde; }

        /* ÈÄÅ‰ø°„Éï„Ç©„Éº„É† */
        #message-form {
            display: flex; padding: 20px; background: #40444b; align-items: center;
        }
        #message-input {
            flex-grow: 1; background: #484c52; border: none;
            border-radius: 8px; padding: 10px 15px;
            color: #dcddde; font-size: 1em; outline: none;
        }
        
        /* „Éó„É≠„Éï„Ç£„Éº„É´Á∑®ÈõÜ„É¢„Éº„ÉÄ„É´ */
        #profile-modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8); display: flex;
            justify-content: center; align-items: center; z-index: 2000;
        }
        #profile-modal { background: #2f3136; padding: 30px; border-radius: 8px; width: 400px; }
        #profile-modal h2 { margin-top: 0; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; color: #b9bbbe; }
        .form-group input { width: 100%; padding: 10px; background: #202225; border: 1px solid #40444b; color: #dcddde; border-radius: 5px; box-sizing: border-box; }
        .modal-buttons { display: flex; justify-content: flex-end; margin-top: 20px; }
        .modal-buttons button { border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; margin-left: 10px; }
        #profile-cancel-btn { background: #747f8d; color: white; }
        #profile-save-btn { background: #5865f2; color: white; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div id="login-box">
            <div class="login-tabs">
                <div class="login-tab active" data-tab="login">„É≠„Ç∞„Ç§„É≥</div>
                <div class="login-tab" data-tab="register">Êñ∞Ë¶èÁôªÈå≤</div>
            </div>

            <form id="login-form">
                <div class="login-form-group">
                    <label for="login-email">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
                    <input type="email" id="login-email" required>
                </div>
                <div class="login-form-group">
                    <label for="login-password">„Éë„Çπ„ÉØ„Éº„Éâ</label>
                    <input type="password" id="login-password" required>
                </div>
                <button type="submit" class="login-btn">„É≠„Ç∞„Ç§„É≥</button>
            </form>
            
            <form id="register-form" class="hidden">
                <div class="login-form-group">
                    <label for="register-name">Ë°®Á§∫Âêç</label>
                    <input type="text" id="register-name" required>
                </div>
                <div class="login-form-group">
                    <label for="register-email">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
                    <input type="email" id="register-email" required>
                </div>
                <div class="login-form-group">
                    <label for="register-password">„Éë„Çπ„ÉØ„Éº„ÉâÔºà6ÊñáÂ≠ó‰ª•‰∏äÔºâ</label>
                    <input type="password" id="register-password" required>
                </div>
                <button type="submit" class="login-btn">ÁôªÈå≤„Åô„Çã</button>
            </form>

            <div class="divider">„Åæ„Åü„ÅØ</div>
            
            <button id="google-login-btn" class="login-btn">Google„Åß„É≠„Ç∞„Ç§„É≥</button>
            
            <p id="login-error"></p>
        </div>
    </div>

    <div id="sidebar" class="hidden"> <div id="sidebar-scroll-container">
            <div id="channel-list-container">
                <h3>ÂÖ¨Èñã„ÉÅ„É£„É≥„Éç„É´</h3>
                <ul id="public-channel-list" class="channel-list"></ul>
                <h3>„Éó„É©„Ç§„Éô„Éº„Éà„ÉÅ„É£„É≥„Éç„É´</h3>
                <ul id="private-channel-list" class="channel-list"></ul>
            </div>
            <div class="sidebar-form-container">
                <form id="join-private-form" class="sidebar-form">
                    <input type="text" id="join-id-input" placeholder="ÂèÇÂä†IDÔºàÂêàË®ÄËëâÔºâ" autocomplete="off" required>
                    <button type="submit">ID„Åß„ÉÅ„É£„É≥„Éç„É´„Å´ÂèÇÂä†</button>
                </form>
                <hr style="border-color: #40444b; margin: 15px 0;">
                <form id="add-channel-form" class="sidebar-form">
                    <input type="text" id="add-channel-input" placeholder="Êñ∞„Åó„ÅÑ„ÉÅ„É£„É≥„Éç„É´Âêç" autocomplete="off" required>
                    <input type="text" id="secret-id-input" placeholder="IDÔºàÂêàË®ÄËëâÔºâ„ÇíË®≠ÂÆö" autocomplete="off" class="hidden">
                    <div class="checkbox-group">
                        <input type="checkbox" id="is-private-checkbox">
                        <label for="is-private-checkbox" style="margin-left: 5px;">ID‰ªò„ÅçÔºàÈùûÂÖ¨ÈñãÔºâ„Å´„Åô„Çã</label>
                    </div>
                    <button type="submit">„ÉÅ„É£„É≥„Éç„É´‰ΩúÊàê</button>
                </form>
            </div>
        </div> 
        <div id="user-info-bar">
            <img id="user-icon" src="" alt="icon">
            <span id="user-name"></span>
            <button id="settings-btn" title="„Éó„É≠„Éï„Ç£„Éº„É´Ë®≠ÂÆö">‚öôÔ∏è</button>
        </div>
    </div>

    <div id="main-content" class="hidden"> <div id="main-header">#<span id="current-channel-name">general</span></div>
        <div id="message-list"></div>
        <form id="message-form">
            <input type="text" id="message-input" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°..." autocomplete="off">
        </form>
    </div>
    
    <div id="profile-modal-overlay" class="hidden">
        <div id="profile-modal">
            <h2>„Éó„É≠„Éï„Ç£„Éº„É´„ÇíÁ∑®ÈõÜ</h2>
            <div class="form-group">
                <label for="profile-name-input">Ë°®Á§∫Âêç</label>
                <input type="text" id="profile-name-input">
            </div>
            <div class="form-group">
                <label for="profile-icon-input">„Ç¢„Ç§„Ç≥„É≥URL</label>
                <input type="text" id="profile-icon-input" placeholder="https://example.com/image.png">
            </div>
            <div class="modal-buttons">
                <button id="profile-cancel-btn">„Ç≠„É£„É≥„Çª„É´</button>
                <button id="profile-save-btn">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase SDK „ÅÆ„Ç≥„Ç¢„É¢„Ç∏„É•„Éº„É´„Çí„Ç§„É≥„Éù„Éº„Éà
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"; // ‚òÖ https://
        // Ë™çË®º (Auth) „Çµ„Éº„Éì„Çπ„Çí„Ç§„É≥„Éù„Éº„Éà
        import { 
            getAuth, 
            GoogleAuthProvider, 
            signInWithPopup, 
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword
        } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"; // ‚òÖ https://
        // Firestore „Éá„Éº„Çø„Éô„Éº„Çπ„Çµ„Éº„Éì„Çπ„Çí„Ç§„É≥„Éù„Éº„Éà
        import { 
            getFirestore, collection, addDoc, query, orderBy, onSnapshot, 
            serverTimestamp, doc, setDoc, updateDoc, getDoc, where,
            arrayUnion, deleteDoc
        } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"; // ‚òÖ https://

        // ‚òÖ‚òÖ‚òÖ „ÅÇ„Å™„Åü„ÅÆFirebaseË®≠ÂÆö (ÁµÑ„ÅøËæº„ÅøÊ∏à„Åø) ‚òÖ‚òÖ‚òÖ
        const firebaseConfig = {
          apiKey: "AIzaSyAhXs223e-Shn8JfnvNC1IS4-T33mtKd-k",
          authDomain: "sexsex-90a07.firebaseapp.com",
          projectId: "sexsex-90a07",
          storageBucket: "sexsex-90a07.appspot.com",
          messagingSenderId: "252347983312",
          appId: "1:252347983312:web:89019e1ee68879839385d5"
        };
        // ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ

        // Firebase „Ç¢„Éó„É™„ÇíÂàùÊúüÂåñ
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // --- 1. Ë™çË®º („É≠„Ç∞„Ç§„É≥) Âá¶ÁêÜ ---
        
        // DOMË¶ÅÁ¥†„ÅÆÂèñÂæó („É≠„Ç∞„Ç§„É≥Èñ¢ÈÄ£)
        const loginOverlay = document.getElementById('login-overlay');
        const loginTabs = document.querySelectorAll('.login-tab');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const loginError = document.getElementById('login-error');
        const googleLoginBtn = document.getElementById('google-login-btn');
        
        // DOMË¶ÅÁ¥†„ÅÆÂèñÂæó („ÉÅ„É£„ÉÉ„ÉàÈñ¢ÈÄ£)
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('main-content');
        const userInfoBar = document.getElementById('user-info-bar');
        const userIcon = document.getElementById('user-icon');
        const userName = document.getElementById('user-name');
        const messageList = document.getElementById('message-list');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const publicChannelList = document.getElementById('public-channel-list');
        const privateChannelList = document.getElementById('private-channel-list');
        const addChannelForm = document.getElementById('add-channel-form');
        const addChannelInput = document.getElementById('add-channel-input');
        const isPrivateCheckbox = document.getElementById('is-private-checkbox');
        const secretIdInput = document.getElementById('secret-id-input');
        const joinPrivateForm = document.getElementById('join-private-form');
        const joinIdInput = document.getElementById('join-id-input');
        const currentChannelName = document.getElementById('current-channel-name');
        const settingsBtn = document.getElementById('settings-btn');
        const profileModalOverlay = document.getElementById('profile-modal-overlay');
        const profileNameInput = document.getElementById('profile-name-input');
        const profileIconInput = document.getElementById('profile-icon-input');
        const profileCancelBtn = document.getElementById('profile-cancel-btn');
        const profileSaveBtn = document.getElementById('profile-save-btn');
        
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let currentUser = null;
        let usersMap = {}; 
        let currentMessages = [];
        let currentChannelId = 'general'; 
        let unsubscribeMessages = null; 
        let unsubscribeMyProfile = null; 

        
        // ‚òÖ„É≠„Ç∞„Ç§„É≥/Êñ∞Ë¶èÁôªÈå≤„ÅÆ„Çø„ÉñÂàá„ÇäÊõø„Åà
        loginTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                loginTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                const activeTab = tab.dataset.tab;
                loginForm.classList.toggle('hidden', activeTab !== 'login');
                registerForm.classList.toggle('hidden', activeTab !== 'register');
                loginError.textContent = ''; // „Ç®„É©„Éº„Çí„ÇØ„É™„Ç¢
            });
        });
        
        // ‚òÖGoogle„É≠„Ç∞„Ç§„É≥
        googleLoginBtn.addEventListener('click', async () => {
            loginError.textContent = '';
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                loginError.textContent = getAuthErrorMessage(error.code);
            }
        });
        
        // ‚òÖ„É°„Éº„É´„Åß„Äå„É≠„Ç∞„Ç§„É≥„Äç
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loginError.textContent = '';
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                loginError.textContent = getAuthErrorMessage(error.code);
            }
        });
        
        // ‚òÖ„É°„Éº„É´„Åß„ÄåÊñ∞Ë¶èÁôªÈå≤„Äç (‚òÖË°®Á§∫Âêç„ÇÇ‰øùÂ≠ò‚òÖ)
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loginError.textContent = '';
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const displayName = document.getElementById('register-name').value.trim(); // ‚òÖË°®Á§∫Âêç„ÇíÂèñÂæó‚òÖ
            
            if (displayName === '') {
                loginError.textContent = 'Ë°®Á§∫Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
                return;
            }
            
            try {
                // 1. Auth„Çµ„Éº„Éì„Çπ„Å´„É¶„Éº„Ç∂„Éº„Çí‰ΩúÊàê
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // 2. ‚òÖFirestore„ÅÆ 'users' ÂêçÁ∞ø„Å´„ÄÅÊâãÂãï„Åß„Éó„É≠„Éï„Ç£„Éº„É´„ÇíÁôªÈå≤‚òÖ
                await setDoc(doc(db, "users", user.uid), {
                    displayName: displayName, // ‚òÖ„Éï„Ç©„Éº„É†„Åã„ÇâÂèñÂæó„Åó„ÅüË°®Á§∫Âêç
                    photoURL: 'https.i.imgur.com/6M6yJ1I.png', // ‚òÖ„Éá„Éï„Ç©„É´„Éà„ÅÆ„Ç¢„Ç§„Ç≥„É≥
                    joinedPrivateChannels: []
                });
                
                // „Åì„Çå„Åß onAuthStateChanged „ÅåÁô∫ÁÅ´„Åó„ÄÅËá™ÂãïÁöÑ„Å´„É≠„Ç∞„Ç§„É≥Áä∂ÊÖã„Å´„Å™„Çã
                
            } catch (error) {
                loginError.textContent = getAuthErrorMessage(error.code);
            }
        });

        // ‚òÖË™çË®ºÁä∂ÊÖã„ÅÆÁõ£Ë¶ñ („É≠„Ç∞„Ç§„É≥/„É≠„Ç∞„Ç¢„Ç¶„Éà„ÇíÊ§úÁü•)
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // „É≠„Ç∞„Ç§„É≥ÊàêÂäü
                currentUser = user;
                loginOverlay.classList.add('hidden'); 
                sidebar.classList.remove('hidden'); // ‚òÖ„ÉÅ„É£„ÉÉ„ÉàUI„ÇíË°®Á§∫
                mainContent.classList.remove('hidden'); // ‚òÖ„ÉÅ„É£„ÉÉ„ÉàUI„ÇíË°®Á§∫
                
                // ‚òÖFirestore„ÅÆ 'users' ÂêçÁ∞ø„ÇíÊ∫ñÂÇô (Google„É≠„Ç∞„Ç§„É≥„ÅÆÂàùÂõûÊôÇ„ÅÆ„Åø)
                await setupUserProfile(user); 
                
                // („Åì„Åì„Åã„Çâ‰∏ã„ÅØ„ÉÅ„É£„ÉÉ„ÉàÊ©üËÉΩ„ÅÆÂëº„Å≥Âá∫„Åó)
                listenToMyProfileAndPrivateChannels(user.uid); 
                listenToUsers(); 
                listenToPublicChannels(); 
                
                // ÊúÄÂæå„Å´ general „ÉÅ„É£„É≥„Éç„É´„Å´Êé•Á∂ö
                switchChannel('general', 'general');
                
            } else {
                // „É≠„Ç∞„Ç¢„Ç¶„ÉàÁä∂ÊÖã
                currentUser = null;
                loginOverlay.classList.remove('hidden'); 
                sidebar.classList.add('hidden'); // ‚òÖ„ÉÅ„É£„ÉÉ„ÉàUI„ÇíÈö†„Åô
                mainContent.classList.add('hidden'); // ‚òÖ„ÉÅ„É£„ÉÉ„ÉàUI„ÇíÈö†„Åô
                
                // „É°„ÉÉ„Çª„Éº„Ç∏„Å®„ÉÅ„É£„É≥„Éç„É´„É™„Çπ„Éà„Çí„ÇØ„É™„Ç¢
                messageList.innerHTML = ''; 
                publicChannelList.innerHTML = '';
                privateChannelList.innerHTML = '';
                
                // Áõ£Ë¶ñ„ÇíÂÅúÊ≠¢
                if (unsubscribeMessages) unsubscribeMessages();
                if (unsubscribeMyProfile) unsubscribeMyProfile();
            }
        });
        
        // ‚òÖ„É¶„Éº„Ç∂„ÉºÂêçÁ∞ø(users)„ÇíÊ∫ñÂÇô„Åô„ÇãÈñ¢Êï∞
        async function setupUserProfile(user) {
            const userRef = doc(db, "users", user.uid);
            const userDoc = await getDoc(userRef);
            
            if (!userDoc.exists()) {
                // ‚òÖ‰∏ª„Å´„ÄåGoogle„É≠„Ç∞„Ç§„É≥„Äç„ÅÆÂàùÂõûÊôÇ„Å´ÂÆüË°å„Åï„Çå„Çã‚òÖ
                await setDoc(userRef, {
                    displayName: user.displayName || 'ÂêçÁÑ°„Åó„Åï„Çì', // GoogleÂêç
                    photoURL: user.photoURL || 'https.i.imgur.com/6M6yJ1I.png', // Google„Ç¢„Ç§„Ç≥„É≥
                    joinedPrivateChannels: []
                });
            }
        }
        
        // ‚òÖË™çË®º„Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÊó•Êú¨Ë™û„Å´Â§âÊèõ„Åô„Çã„Éò„É´„Éë„Éº
        function getAuthErrorMessage(code) {
            switch (code) {
                case 'auth/invalid-email':
                    return 'ÁÑ°Âäπ„Å™„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Åß„Åô„ÄÇ';
                case 'auth/user-not-found':
                    return '„É¶„Éº„Ç∂„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ';
                case 'auth/wrong-password':
                    return '„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÈñìÈÅï„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇ';
                case 'auth/email-already-in-use':
                    return '„Åù„ÅÆ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅØÊó¢„Å´‰ΩøÁî®„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ';
                case 'auth/weak-password':
                    return '„Éë„Çπ„ÉØ„Éº„Éâ„ÅØ6ÊñáÂ≠ó‰ª•‰∏ä„ÅßË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
                default:
                    return '„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + code;
            }
        }

        // --- 2. „ÉÅ„É£„É≥„Éç„É´Âá¶ÁêÜ ---
        function listenToMyProfileAndPrivateChannels(uid) {
            const userRef = doc(db, "users", uid);
            unsubscribeMyProfile = onSnapshot(userRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    userIcon.src = data.photoURL || 'https.i.imgur.com/6M6yJ1I.png'; // ‚òÖ
                    userName.textContent = data.displayName;
                    // „Éó„É≠„Éï„Ç£„Éº„É´Á∑®ÈõÜ„É¢„Éº„ÉÄ„É´„ÅÆ„Åü„ÇÅ
                    profileNameInput.value = data.displayName;
                    profileIconInput.value = data.photoURL;
                }
            });
        }
        async function renderPrivateChannels(idArray) {
            privateChannelList.innerHTML = ''; 
            for (const id of idArray) {
                try { // ‚òÖÂâäÈô§„Åï„Çå„ÅüCH„ÇíË™≠„ÅøËæº„ÇÇ„ÅÜ„Å®„Åó„ÅüÊôÇ„ÅÆ„Ç®„É©„ÉºÂØæÁ≠ñ
                    const channelDoc = await getDoc(doc(db, "channels", id));
                    if (channelDoc.exists()) {
                        const channel = channelDoc.data();
                        const li = createChannelElement(channelDoc.id, channel.name, true, channel.ownerId); 
                        privateChannelList.appendChild(li);
                    }
                } catch(e) { console.warn("Ë™≠„ÅøËæº„ÇÅ„Å™„ÅÑ„ÉÅ„É£„É≥„Éç„É´„Åå„ÅÇ„Çä„Åæ„Åô:", id); }
            }
        }
        function listenToPublicChannels() {
            const q = query(collection(db, "channels"), where("secretId", "==", null), orderBy("name"));
            onSnapshot(q, (snapshot) => {
                publicChannelList.innerHTML = ''; 
                let channelsExist = false;
                snapshot.forEach((doc) => {
                    channelsExist = true;
                    const channel = doc.data();
                    const li = createChannelElement(doc.id, channel.name, false, channel.ownerId); 
                    publicChannelList.appendChild(li);
                });
                if (!channelsExist) {
                    addDoc(collection(db, "channels"), { 
                        name: "general", 
                        secretId: null, 
                        ownerId: "system" 
                    });
                }
            });
        }
        function createChannelElement(id, name, isPrivate, ownerId) {
            const li = document.createElement('li');
            li.className = 'channel-item';
            li.dataset.id = id; 
            const nameSpan = document.createElement('span');
            nameSpan.className = 'channel-name';
            nameSpan.innerHTML = `${isPrivate ? '<span class="lock-icon">üîí</span> ' : '# '} ${name}`;
            nameSpan.addEventListener('click', () => {
                switchChannel(id, name);
            });
            li.appendChild(nameSpan);
            if (ownerId === currentUser.uid && id !== 'general') { // ‚òÖgeneral„ÅØÂâäÈô§‰∏çÂèØ
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-channel-btn';
                deleteBtn.innerHTML = 'üóëÔ∏è';
                deleteBtn.title = '„ÉÅ„É£„É≥„Éç„É´„ÇíÂâäÈô§';
                deleteBtn.style.display = 'inline-block'; 
                deleteBtn.addEventListener('click', async (e) => {
                    e.stopPropagation(); 
                    if (confirm(`„ÉÅ„É£„É≥„Éç„É´„Äå${name}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
                        try {
                            await deleteDoc(doc(db, "channels", id));
                            if (id === currentChannelId) {
                                switchChannel('general', 'general');
                            }
                        } catch (error) {
                            console.error("„ÉÅ„É£„É≥„Éç„É´ÂâäÈô§„Ç®„É©„Éº:", error);
                        }
                    }
                });
                li.appendChild(deleteBtn);
            }
            if (id === currentChannelId) li.classList.add('active');
            return li;
        }
        addChannelForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const channelName = addChannelInput.value.trim();
            if (channelName === '' || !currentUser) return;
            const newChannelData = {
                name: channelName,
                secretId: null,
                ownerId: currentUser.uid
            };
            if (isPrivateCheckbox.checked) {
                const secretId = secretIdInput.value.trim();
                if (secretId === '') return alert('IDÔºàÂêàË®ÄËëâÔºâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                newChannelData.secretId = secretId;
            }
            try {
                const docRef = await addDoc(collection(db, "channels"), newChannelData);
                if (newChannelData.secretId !== null) {
                    const userRef = doc(db, "users", currentUser.uid);
                    await updateDoc(userRef, { joinedPrivateChannels: arrayUnion(docRef.id) });
                    switchChannel(docRef.id, newChannelData.name);
                }
                addChannelInput.value = '';
                secretIdInput.value = '';
                isPrivateCheckbox.checked = false;
                secretIdInput.classList.add('hidden');
            } catch (error) { console.error("„ÉÅ„É£„É≥„Éç„É´ËøΩÂä†„Ç®„É©„Éº:", error); }
        });
        joinPrivateForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const secretId = joinIdInput.value.trim();
            if (secretId === '' || !currentUser) return;
            const q = query(collection(db, "channels"), where("secretId", "==", secretId));
            const snapshot = await getDoc(q); 
            if (snapshot.empty) {
                alert('IDÔºàÂêàË®ÄËëâÔºâ„ÅåÈñìÈÅï„Å£„Å¶„ÅÑ„Çã„Åã„ÄÅ„ÉÅ„É£„É≥„Éç„É´„ÅåÂ≠òÂú®„Åó„Åæ„Åõ„Çì„ÄÇ');
            } else {
                const foundDoc = snapshot.docs[0];
                const userRef = doc(db, "users", currentUser.uid);
                await updateDoc(userRef, { joinedPrivateChannels: arrayUnion(foundDoc.id) });
                switchChannel(foundDoc.id, foundDoc.data().name);
                joinIdInput.value = '';
            }
        });
        function switchChannel(channelId, channelName) {
            if (unsubscribeMessages) unsubscribeMessages();
            currentChannelId = channelId; 
            currentChannelName.textContent = channelName; 
            document.querySelectorAll('.channel-item').forEach(el => {
                el.classList.toggle('active', el.dataset.id === channelId);
            });
            listenToMessages(channelId);
        }

        // --- 3. „É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅÂèó‰ø°Âá¶ÁêÜ ---
        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault(); 
            const text = messageInput.value.trim();
            if (text === '' || !currentUser) return; 
            try {
                await addDoc(collection(db, "messages"), {
                    senderId: currentUser.uid, 
                    channelId: currentChannelId, 
                    timestamp: serverTimestamp(),
                    text: text 
                });
                messageInput.value = ''; 
            } catch (error) { 
                console.error("„É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°„Ç®„É©„Éº:", error); 
                alert("ÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ");
            }
        });
        function listenToUsers() {
            const usersRef = collection(db, "users");
            onSnapshot(usersRef, (snapshot) => {
                snapshot.docs.forEach(doc => { usersMap[doc.id] = doc.data(); });
                renderAllMessages(); 
            });
        }
        function listenToMessages(channelId) {
            const q = query(
                collection(db, "messages"), 
                where("channelId", "==", channelId),
                orderBy("timestamp")
            );
            unsubscribeMessages = onSnapshot(q, (querySnapshot) => {
                currentMessages = querySnapshot.docs.map(doc => doc.data());
                renderAllMessages();
            });
        }
        function renderAllMessages() {
            messageList.innerHTML = ''; 
            currentMessages.forEach(msgData => { 
                const senderInfo = usersMap[msgData.senderId] || { displayName: '‰∏çÊòé„Å™„É¶„Éº„Ç∂„Éº', photoURL: 'https.i.imgur.com/6M6yJ1I.png' };
                displayMessage(senderInfo.displayName, senderInfo.photoURL, msgData.text);
            });
            messageList.scrollTop = messageList.scrollHeight;
        }

        // --- 4. „É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫„Éò„É´„Éë„Éº ---
        function displayMessage(name, icon, text) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message';
            const safeIcon = icon || 'https.i.imgur.com/6M6yJ1I.png'; // ‚òÖ
            const safeText = text || ''; 
            const escapedText = safeText.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            const messageBodyHTML = `<div class="message-text">${escapedText}</div>`;
            msgDiv.innerHTML = `
                <img src="${safeIcon}" class="message-icon" alt="${name}">
                <div class="message-content">
                    <div class="message-sender">${name}</div>
                    ${messageBodyHTML}
                </div>
            `;
            messageList.appendChild(msgDiv);
        }
        
        // --- 5. „Éó„É≠„Éï„Ç£„Éº„É´Á∑®ÈõÜ„É¢„Éº„ÉÄ„É´ ---
        settingsBtn.addEventListener('click', () => { profileModalOverlay.classList.remove('hidden'); });
        profileCancelBtn.addEventListener('click', () => { profileModalOverlay.classList.add('hidden'); });
        profileSaveBtn.addEventListener('click', async () => {
            const newName = profileNameInput.value.trim();
            let newIcon = profileIconInput.value.trim();
            if (newName === '') return alert('ÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            if (newIcon === '') newIcon = 'https.i.imgur.com/6M6yJ1I.png'; // ‚òÖ
            if (!currentUser) return;
            try {
                const userRef = doc(db, "users", currentUser.uid);
                await updateDoc(userRef, { displayName: newName, photoURL: newIcon });
                profileModalOverlay.classList.add('hidden');
            } catch (error) { console.error("„Éó„É≠„Éï„Ç£„Éº„É´Êõ¥Êñ∞„Ç®„É©„Éº:", error); }
        });

    </script>
</body>
</html>
