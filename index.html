<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poptyper (チャット機能付き)</title>
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden; /* スクロールバーを消す */
        }
        #game-container {
            width: 800px;
            padding: 20px;
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            text-align: center;
        }
        #title-screen {
            display: block; /* 最初はタイトルを表示 */
        }
        #game-screen {
            display: none; /* ゲーム画面は最初は隠す */
            position: relative; /* ポップアップのために必要 */
            height: 400px; /* ゲームエリアの高さを固定 */
            overflow: hidden; /* エリア外の文字を隠す */
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fafafa;
        }
        h1 {
            color: #1a73e8;
            margin-top: 0;
        }
        p {
            font-size: 1.1em;
            line-height: 1.6;
        }
        button {
            background-color: #1a73e8;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 1em;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #185abc;
        }
        #score-display {
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
        }
        #time-display {
            position: absolute;
            top: 10px;
            left: 20px;
            font-size: 1.5em;
            font-weight: bold;
            color: #e63946;
        }
        .falling-word {
            position: absolute;
            background: #fff;
            border: 1px solid #ccc;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 1.2em;
            font-weight: 500;
            user-select: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .typed {
            color: #e63946; /* タイプ済みの文字色 */
            font-weight: bold;
        }

        /* ★★★ (ここからチャット用のCSS) ★★★ */
        
        /* 画面全体を覆う暗いオーバーレイ */
        #chat-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* iframeを囲うコンテナ */
        #chat-iframe-container {
            width: 90%;
            height: 90%;
            max-width: 1200px;
            max-height: 800px;
            background: #36393f; /* chat.htmlの背景色に合わせる */
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden; /* 角丸を効かせるため */
        }

        /* チャットを閉じるボタン */
        #close-chat-btn {
            background: #747f8d;
            color: white;
            font-weight: bold;
            border: none;
            padding: 8px 15px;
            cursor: pointer;
            align-self: flex-end; /* 右上に配置 */
            margin: 10px;
            border-radius: 5px;
            z-index: 1002;
        }
        #close-chat-btn:hover {
            background: #f04747; /* ホバー時は赤く */
        }
        
        /* chat.html を埋め込む iframe */
        #chat-iframe {
            width: 100%;
            height: 100%;
            border: none;
            flex-grow: 1; /* 残りの高さをすべて使う */
        }
        
        /* 隠すための汎用クラス */
        .hidden {
            display: none !important;
        }
        /* ★★★ (チャットCSS ここまで) ★★★ */

    </style>
</head>
<body>

    <div id="game-container">
        
        <div id="title-screen">
            <h1>Poptyper (チャット機能付き)</h1>
            <p>画面上から落ちてくる単語をタイプして消そう！</p>
            <p>準備ができたら「ゲームスタート」を押してください。</p>
            <p style="font-size: 0.9em; color: #555;">(ヒント: キーボードで「c」「h」「a」「t」と入力すると…？)</p>
            <button id="start-button">ゲームスタート</button>
        </div>

        <div id="game-screen">
            <div id="score-display">Score: 0</div>
            <div id="time-display">Time: 60</div>
            </div>

    </div>

    <div id="chat-modal-overlay" class="hidden">
        <div id="chat-iframe-container">
            <button id="close-chat-btn">チャットを閉じる ×</button>
            
            <iframe id="chat-iframe" src="https://naw0fu0a9w09.netlify.app/"></iframe>
            </div>
    </div>
    <script>
        // --- ゲームのDOM要素 ---
        const titleScreen = document.getElementById('title-screen');
        const gameScreen = document.getElementById('game-screen');
        const startButton = document.getElementById('start-button');
        const scoreDisplay = document.getElementById('score-display');
        const timeDisplay = document.getElementById('time-display');

        // --- ★チャットのDOM要素 ---
        const chatModalOverlay = document.getElementById('chat-modal-overlay');
        const closeChatBtn = document.getElementById('close-chat-btn');
        const chatIframe = document.getElementById('chat-iframe');
        // 元のチャットURLを保持
        const baseChatUrl = chatIframe.src; 

        // --- ゲームの変数 ---
        let score = 0;
        let timeLeft = 60;
        let gameInterval;
        let wordInterval;
        let fallingWords = []; // 画面上の単語を管理する配列
        let currentWordElement = null; // 現在タイプ中の単語
        let currentWordIndex = 0; // 現在タイプ中の文字インデックス

        // 単語リスト (自由に追加・変更してください)
        const wordList = [
            "hello", "world", "javascript", "typing", "game", "poptyper",
            "firebase", "chat", "realtime", "function", "style", "html",
            "css", "developer", "coding", "awesome", "project"
        ];
        
        // --- ★チャット起動用の変数 ---
        let keyBuffer = ""; // 入力されたキーを保持する

        // --- ゲームロジック ---

        // ゲームスタート処理
        startButton.addEventListener('click', startGame);

        function startGame() {
            titleScreen.style.display = 'none';
            gameScreen.style.display = 'block';

            score = 0;
            timeLeft = 60;
            scoreDisplay.textContent = `Score: 0`;
            timeDisplay.textContent = `Time: 60`;
            fallingWords = [];
            gameScreen.querySelectorAll('.falling-word').forEach(word => word.remove()); // 前回の単語を消す
            
            // 1秒ごとにタイマーを動かす
            gameInterval = setInterval(() => {
                timeLeft--;
                timeDisplay.textContent = `Time: ${timeLeft}`;
                if (timeLeft <= 0) {
                    endGame();
                }
            }, 1000);

            // 1.5秒ごとに新しい単語を生成
            wordInterval = setInterval(createWord, 1500);

            // 単語を動かすアニメーションループを開始
            requestAnimationFrame(updateGameArea);
        }

        // ゲーム終了処理
        function endGame() {
            clearInterval(gameInterval);
            clearInterval(wordInterval);
            
            setTimeout(() => {
                alert(`ゲーム終了！ スコアは ${score} でした。`);
                titleScreen.style.display = 'block';
                gameScreen.style.display = 'none';
            }, 500);
        }

        // 新しい単語を生成
        function createWord() {
            if (timeLeft <= 0) return; // ゲーム終了時は作らない

            const wordText = wordList[Math.floor(Math.random() * wordList.length)];
            const wordElement = document.createElement('div');
            wordElement.className = 'falling-word';
            wordElement.textContent = wordText;
            wordElement.dataset.word = wordText; // 元の単語をデータとして保持
            
            const gameRect = gameScreen.getBoundingClientRect();
            const maxLeft = gameRect.width - (wordText.length * 15 + 20); // 単語の幅をざっくり計算
            wordElement.style.left = `${Math.random() * maxLeft}px`;
            wordElement.style.top = '0px';

            gameScreen.appendChild(wordElement);
            fallingWords.push(wordElement);
        }

        // 毎フレーム単語を落とす処理
        function updateGameArea() {
            if (timeLeft <= 0) return; // ゲーム終了

            fallingWords.forEach((wordElement, index) => {
                let top = parseFloat(wordElement.style.top);
                top += 1; // 落下速度 (数字を大きくすると速くなる)
                wordElement.style.top = `${top}px`;

                // 画面外に落ちたら
                if (top > gameScreen.clientHeight) {
                    wordElement.remove();
                    fallingWords.splice(index, 1);
                    if (wordElement === currentWordElement) {
                        resetCurrentWord();
                    }
                }
            });

            requestAnimationFrame(updateGameArea); // 次のフレームを予約
        }
        
        // ★★★ (キー入力処理のバグ修正) ★★★
        document.addEventListener('keydown', (e) => {
            const key = e.key; // 押されたキー (大文字/小文字やShiftなども含む)
            
            // ★★★ (修正箇所 1) ★★★
            // ★ゲームとチャット判定に使う「小文字のキー」を用意★
            const typedKey = key.toLowerCase();
            // ★★★ (修正ここまで 1) ★★★
            
            // --- 1. チャット起動の判定 ---
            if (typedKey.length === 1 && typedKey.match(/[a-z]/i)) { // アルファベットのみ
                keyBuffer += typedKey;
                
                if (keyBuffer.includes("chat")) {
                    openChat();
                    keyBuffer = ""; // バッファをリセット
                }
                if (keyBuffer.length > 4) {
                    keyBuffer = keyBuffer.slice(-4);
                }
            }
            
            // --- 2. ゲームのタイピング判定 ---
            
            // ★チャットが開いている時は、ゲーム入力を無効化★
            if (!chatModalOverlay.classList.contains('hidden')) {
                return;
            }
            
            // ゲーム画面が表示されていない時は、ゲーム入力を無効化
            if (gameScreen.style.display === 'none') {
                return;
            }

            // ★「Shift」や「Enter」などの制御キーは無視する★
            // (この判定は `key` (大文字小文字判別) で行う)
            if (key.length > 1) return;
            // ★アルファベットと数字以外は無視する (日本語入力なども弾く)★
            if (!key.match(/^[a-zA-Z0-9]$/)) return;


            // まだ何もタイプしていない場合
            if (currentWordElement === null) {
                // 押されたキーで始まる単語を探す
                for (const wordEl of fallingWords) {
                    
                    // ★★★ (修正箇所 2) ★★★
                    // ★「typedKey」(小文字) で比較する★
                    if (wordEl.dataset.word.startsWith(typedKey)) { 
                        currentWordElement = wordEl;
                        currentWordIndex = 1; // 1文字目をタイプした
                        updateWordAppearance();
                        return; // 一致したら終了
                    }
                }
            } 
            // すでにタイプ中の単語がある場合
            else {
                const targetWord = currentWordElement.dataset.word;
                
                // ★★★ (修正箇所 3) ★★★
                // ★「typedKey」(小文字) で比較する★
                if (targetWord[currentWordIndex] === typedKey) {
                    currentWordIndex++;
                    updateWordAppearance();
                    
                    // 単語をタイプし終えた場合
                    if (currentWordIndex === targetWord.length) {
                        wordTyped();
                    }
                } 
                // タイプミス
                else {
                    resetCurrentWord();
                }
            }
        });
        // ★★★ (修正ここまで) ★★★


        // 単語の見た目を更新 (タイプ済みの文字を赤くする)
        function updateWordAppearance() {
            if (!currentWordElement) return;
            const word = currentWordElement.dataset.word;
            const typedPart = `<span class="typed">${word.substring(0, currentWordIndex)}</span>`;
            const remainingPart = word.substring(currentWordIndex);
            currentWordElement.innerHTML = typedPart + remainingPart;
        }

        // タイプをリセット
        function resetCurrentWord() {
            if (currentWordElement) {
                currentWordElement.innerHTML = currentWordElement.dataset.word; // 見た目を元に戻す
            }
            currentWordElement = null;
            currentWordIndex = 0;
        }

        // 単語をタイプ完了した時の処理
        function wordTyped() {
            score += currentWordElement.dataset.word.length; // 文字数でスコア加算
            scoreDisplay.textContent = `Score: ${score}`;
            
            // 画面と配列から削除
            currentWordElement.remove();
            fallingWords = fallingWords.filter(wordEl => wordEl !== currentWordElement);
            
            resetCurrentWord(); // 次の単語に備える
        }

        // --- ★チャットを開く/閉じる処理 ---
        
        function openChat() {
            chatIframe.src = `${baseChatUrl}?t=${new Date().getTime()}`;
            chatModalOverlay.classList.remove('hidden');
        }

        function closeChat() {
            chatModalOverlay.classList.add('hidden');
            chatIframe.src = "about:blank"; 
            keyBuffer = ""; 
        }

        // 閉じるボタンのイベント
        closeChatBtn.addEventListener('click', closeChat);

    </script>
</body>
</html>
