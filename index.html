<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒ£ãƒƒãƒˆ (IDãƒãƒ£ãƒ³ãƒãƒ«æ©Ÿèƒ½)</title>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #36393f;
            color: #dcddde;
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ */
        #login-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8); display: flex;
            justify-content: center; align-items: center; z-index: 1000;
        }
        #login-box {
            background: #2f3136; padding: 40px; border-radius: 8px; text-align: center;
        }
        #login-btn {
            background: #5865f2; color: white; border: none;
            padding: 10px 20px; font-size: 1.2em; border-radius: 5px; cursor: pointer;
        }

        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
        #sidebar {
            width: 240px;
            background: #2f3136;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* â˜…ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯¾ç­–â˜… */
        }
        
        /* â˜…ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚³ãƒ³ãƒ†ãƒŠâ˜… */
        #sidebar-scroll-container {
            flex-grow: 1;
            overflow-y: auto; /* â˜…ã“ã“ãŒã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã™ã‚‹â˜… */
        }
        
        /* ãƒãƒ£ãƒ³ãƒãƒ«ãƒªã‚¹ãƒˆ */
        #channel-list-container {
            padding: 10px;
        }
        #channel-list-container h3 {
            margin: 10px 5px 5px;
            color: #8e9297;
            font-size: 0.8em;
            text-transform: uppercase;
        }
        .channel-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .channel-item {
            padding: 8px 10px; border-radius: 5px; cursor: pointer;
            color: #8e9297; font-weight: 500;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .channel-item:hover { background: #3a3c43; color: #dcddde; }
        .channel-item.active { background: #40444b; color: #ffffff; }
        .channel-item .lock-icon { margin-right: 5px; color: #b9bbbe; }
        
        /* ãƒãƒ£ãƒ³ãƒãƒ«å‚åŠ /ä½œæˆãƒ•ã‚©ãƒ¼ãƒ  */
        .sidebar-form-container {
            padding: 10px;
            border-top: 1px solid #40444b;
        }
        .sidebar-form {
            display: flex; flex-direction: column; gap: 8px;
        }
        .sidebar-form input[type="text"] {
            background: #202225; border: none; color: #dcddde;
            padding: 8px; border-radius: 3px; font-size: 0.9em;
        }
        .sidebar-form button {
            background: #5865f2; color: white; border: none;
            padding: 8px; border-radius: 3px; cursor: pointer;
        }
        .checkbox-group {
            display: flex; align-items: center;
            font-size: 0.9em; color: #b9bbbe;
        }

        /* ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± (ã‚µã‚¤ãƒ‰ãƒãƒ¼ä¸‹éƒ¨) */
        #user-info-bar {
            background: #292b2f; padding: 10px; display: flex;
            align-items: center; flex-shrink: 0;
        }
        #user-info-bar img {
            width: 32px; height: 32px; border-radius: 50%; margin-right: 10px;
        }
        #user-info-bar span {
            font-size: 0.9em; font-weight: 500;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-grow: 1;
        }
        #settings-btn {
            background: none; border: none; color: #b9bbbe;
            font-size: 1.2em; cursor: pointer; margin-left: auto; padding: 5px; flex-shrink: 0;
        }
        #settings-btn:hover { color: #fff; }

        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
        #main-content {
            flex-grow: 1; display: flex; flex-direction: column; background: #36393f;
        }
        #main-header {
            padding: 20px; border-bottom: 1px solid #40444b;
            box-shadow: 0 1px 0 rgba(0,0,0,.2); font-size: 1.2em;
            font-weight: bold; color: #fff;
        }

        /* ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ */
        #message-list {
            flex-grow: 1; padding: 20px; overflow-y: auto;
        }
        .message { margin-bottom: 15px; display: flex; }
        .message-icon { width: 40px; height: 40px; border-radius: 50%; margin-right: 15px; flex-shrink: 0; }
        .message-content { padding-top: 5px; }
        .message-sender { font-weight: bold; color: #fff; margin-bottom: 5px; }
        .message-text { line-height: 1.4; color: #dcddde; }
        /* (ç”»åƒç”¨ã®CSS .message-image ã¯å‰Šé™¤æ¸ˆã¿) */

        /* é€ä¿¡ãƒ•ã‚©ãƒ¼ãƒ  */
        #message-form {
            display: flex; padding: 20px; background: #40444b; align-items: center; /* â˜… */
        }
        /* (ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ + ã®CSSã¯å‰Šé™¤æ¸ˆã¿) */
        
        #message-input {
            flex-grow: 1; background: #484c52; border: none;
            border-radius: 8px; padding: 10px 15px;
            color: #dcddde; font-size: 1em; outline: none;
        }
        
        /* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« (CSSã¯å¤‰æ›´ãªã—) */
        #profile-modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8); display: flex;
            justify-content: center; align-items: center; z-index: 2000;
        }
        #profile-modal { background: #2f3136; padding: 30px; border-radius: 8px; width: 400px; }
        #profile-modal h2 { margin-top: 0; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; color: #b9bbbe; }
        .form-group input { width: 100%; padding: 10px; background: #202225; border: 1px solid #40444b; color: #dcddde; border-radius: 5px; box-sizing: border-box; }
        .modal-buttons { display: flex; justify-content: flex-end; margin-top: 20px; }
        .modal-buttons button { border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; margin-left: 10px; }
        #profile-cancel-btn { background: #747f8d; color: white; }
        #profile-save-btn { background: #5865f2; color: white; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div id="login-box">
            <h2>ãƒãƒ£ãƒƒãƒˆã¸ã‚ˆã†ã“ã</h2>
            <button id="login-btn">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
        </div>
    </div>

    <div id="sidebar">
        <div id="sidebar-scroll-container">
            <div id="channel-list-container">
                <h3>å…¬é–‹ãƒãƒ£ãƒ³ãƒãƒ«</h3>
                <ul id="public-channel-list" class="channel-list"></ul>
                <h3>ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒãƒ£ãƒ³ãƒãƒ«</h3>
                <ul id="private-channel-list" class="channel-list"></ul>
            </div>
            
            <div class="sidebar-form-container">
                <form id="join-private-form" class="sidebar-form">
                    <input type="text" id="join-id-input" placeholder="å‚åŠ IDï¼ˆåˆè¨€è‘‰ï¼‰" autocomplete="off" required>
                    <button type="submit">IDã§ãƒãƒ£ãƒ³ãƒãƒ«ã«å‚åŠ </button>
                </form>
                <hr style="border-color: #40444b; margin: 15px 0;">
                <form id="add-channel-form" class="sidebar-form">
                    <input type="text" id="add-channel-input" placeholder="æ–°ã—ã„ãƒãƒ£ãƒ³ãƒãƒ«å" autocomplete="off" required>
                    <input type="text" id="secret-id-input" placeholder="IDï¼ˆåˆè¨€è‘‰ï¼‰ã‚’è¨­å®š" autocomplete="off" class="hidden">
                    <div class="checkbox-group">
                        <input type="checkbox" id="is-private-checkbox">
                        <label for="is-private-checkbox" style="margin-left: 5px;">IDä»˜ãï¼ˆéå…¬é–‹ï¼‰ã«ã™ã‚‹</label>
                    </div>
                    <button type="submit">ãƒãƒ£ãƒ³ãƒãƒ«ä½œæˆ</button>
                </form>
            </div>
        </div> <div id="user-info-bar" class="hidden">
            <img id="user-icon" src="" alt="icon">
            <span id="user-name"></span>
            <button id="settings-btn" title="ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®š">âš™ï¸</button>
        </div>
    </div>

    <div id="main-content">
        <div id="main-header">#<span id="current-channel-name">general</span></div>
        <div id="message-list"></div>
        
        <form id="message-form">
            <input type="text" id="message-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡..." autocomplete="off">
        </form>
    </div>
    
    <div id="profile-modal-overlay" class="hidden">
        <div id="profile-modal">
            <h2>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ç·¨é›†</h2>
            <div class="form-group">
                <label for="profile-name-input">è¡¨ç¤ºå</label>
                <input type="text" id="profile-name-input">
            </div>
            <div class="form-group">
                <label for="profile-icon-input">ã‚¢ã‚¤ã‚³ãƒ³URL</label>
                <input type="text" id="profile-icon-input" placeholder="https://example.com/image.png">
            </div>
            <div class="modal-buttons">
                <button id="profile-cancel-btn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="profile-save-btn">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase SDK ã®ã‚³ã‚¢ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        // èªè¨¼ (Auth) ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        // Firestore ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        import { 
            getFirestore, collection, addDoc, query, orderBy, onSnapshot, 
            serverTimestamp, doc, setDoc, updateDoc, getDoc, where,
            arrayUnion 
        } from "https.www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
        // (Storage (ç”»åƒä¿å­˜) ã‚µãƒ¼ãƒ“ã‚¹ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã¯å‰Šé™¤æ¸ˆã¿)

        // â˜…â˜…â˜… ã‚ãªãŸã®Firebaseè¨­å®š (çµ„ã¿è¾¼ã¿æ¸ˆã¿) â˜…â˜…â˜…
        const firebaseConfig = {
          apiKey: "AIzaSyAhXs223e-Shn8JfnvNC1IS4-T33mtKd-k",
          authDomain: "sexsex-90a07.firebaseapp.com",
          projectId: "sexsex-90a07",
          // storageBucket: "sexsex-90a07.appspot.com", // â† ä½¿ã‚ãªã„ã®ã§ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
          messagingSenderId: "252347983312",
          appId: "1:252347983312:web:89019e1ee68879839385d5"
        };
        // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…

        // Firebase ã‚¢ãƒ—ãƒªã‚’åˆæœŸåŒ–
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        // (Storage ã®åˆæœŸåŒ–ã¯å‰Šé™¤æ¸ˆã¿)
        
        // DOMè¦ç´ ã®å–å¾—
        const loginOverlay = document.getElementById('login-overlay');
        const loginBtn = document.getElementById('login-btn');
        const userInfoBar = document.getElementById('user-info-bar');
        const userIcon = document.getElementById('user-icon');
        const userName = document.getElementById('user-name');
        const messageList = document.getElementById('message-list');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        
        // (ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–¢é€£DOMã¯å‰Šé™¤æ¸ˆã¿)
        
        // ãƒãƒ£ãƒ³ãƒãƒ«é–¢é€£ã®DOM
        const publicChannelList = document.getElementById('public-channel-list');
        const privateChannelList = document.getElementById('private-channel-list');
        const addChannelForm = document.getElementById('add-channel-form');
        const addChannelInput = document.getElementById('add-channel-input');
        const isPrivateCheckbox = document.getElementById('is-private-checkbox');
        const secretIdInput = document.getElementById('secret-id-input');
        const joinPrivateForm = document.getElementById('join-private-form');
        const joinIdInput = document.getElementById('join-id-input');
        const currentChannelName = document.getElementById('current-channel-name');
        
        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ã®DOM
        const settingsBtn = document.getElementById('settings-btn');
        const profileModalOverlay = document.getElementById('profile-modal-overlay');
        const profileNameInput = document.getElementById('profile-name-input');
        const profileIconInput = document.getElementById('profile-icon-input');
        const profileCancelBtn = document.getElementById('profile-cancel-btn');
        const profileSaveBtn = document.getElementById('profile-save-btn');

        let currentUser = null;
        let usersMap = {}; 
        let currentMessages = [];
        let currentChannelId = 'general'; 
        let unsubscribeMessages = null; 
        let unsubscribeMyProfile = null; 

        // --- 1. èªè¨¼ (ãƒ­ã‚°ã‚¤ãƒ³) å‡¦ç† (å¤‰æ›´ãªã—) ---
        loginBtn.addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try { await signInWithPopup(auth, provider); } catch (error) { console.error("ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:", error); }
        });
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                loginOverlay.classList.add('hidden'); 
                await setupUserProfile(user); 
                listenToMyProfileAndPrivateChannels(user.uid); 
                userInfoBar.classList.remove('hidden'); 
                listenToUsers(); 
                listenToPublicChannels(); 
                switchChannel('general', 'general'); 
            } else {
                currentUser = null;
                loginOverlay.classList.remove('hidden'); 
                userInfoBar.classList.add('hidden'); 
                messageList.innerHTML = ''; 
                publicChannelList.innerHTML = '';
                privateChannelList.innerHTML = '';
                if (unsubscribeMessages) unsubscribeMessages();
                if (unsubscribeMyProfile) unsubscribeMyProfile();
            }
        });
        async function setupUserProfile(user) {
            const userRef = doc(db, "users", user.uid);
            const userDoc = await getDoc(userRef);
            if (!userDoc.exists()) {
                await setDoc(userRef, {
                    displayName: user.displayName,
                    photoURL: user.photoURL,
                    joinedPrivateChannels: [] 
                });
            }
        }
        function listenToMyProfileAndPrivateChannels(uid) {
            const userRef = doc(db, "users", uid);
            unsubscribeMyProfile = onSnapshot(userRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    userIcon.src = data.photoURL;
                    userName.textContent = data.displayName;
                    profileNameInput.value = data.displayName;
                    profileIconInput.value = data.photoURL;
                    renderPrivateChannels(data.joinedPrivateChannels || []);
                }
            });
        }
        async function renderPrivateChannels(idArray) {
            privateChannelList.innerHTML = ''; 
            for (const id of idArray) {
                const channelDoc = await getDoc(doc(db, "channels", id));
                if (channelDoc.exists()) {
                    const channel = channelDoc.data();
                    const li = createChannelElement(channelDoc.id, channel.name, true); 
                    privateChannelList.appendChild(li);
                }
            }
        }

        // --- 2. ãƒãƒ£ãƒ³ãƒãƒ«å‡¦ç† (å¤‰æ›´ãªã—) ---
        function listenToPublicChannels() {
            const q = query(collection(db, "channels"), where("secretId", "==", null), orderBy("name"));
            onSnapshot(q, (snapshot) => {
                publicChannelList.innerHTML = ''; 
                let channelsExist = false;
                snapshot.forEach((doc) => {
                    channelsExist = true;
                    const li = createChannelElement(doc.id, doc.data().name, false); 
                    publicChannelList.appendChild(li);
                });
                if (!channelsExist) {
                    addDoc(collection(db, "channels"), { name: "general", secretId: null });
                }
            });
        }
        function createChannelElement(id, name, isPrivate) {
            const li = document.createElement('li');
            li.className = 'channel-item';
            li.dataset.id = id; 
            li.innerHTML = `${isPrivate ? '<span class="lock-icon">ğŸ”’</span> ' : '# '} ${name}`;
            if (id === currentChannelId) li.classList.add('active');
            li.addEventListener('click', () => { switchChannel(id, name); });
            return li;
        }
        isPrivateCheckbox.addEventListener('change', () => {
            secretIdInput.classList.toggle('hidden', !isPrivateCheckbox.checked);
            secretIdInput.required = isPrivateCheckbox.checked;
        });
        addChannelForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const channelName = addChannelInput.value.trim();
            if (channelName === '' || !currentUser) return;
            const newChannelData = { name: channelName, secretId: null };
            if (isPrivateCheckbox.checked) {
                const secretId = secretIdInput.value.trim();
                if (secretId === '') return alert('IDï¼ˆåˆè¨€è‘‰ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                newChannelData.secretId = secretId;
            }
            try {
                const docRef = await addDoc(collection(db, "channels"), newChannelData);
                if (newChannelData.secretId !== null) {
                    const userRef = doc(db, "users", currentUser.uid);
                    await updateDoc(userRef, { joinedPrivateChannels: arrayUnion(docRef.id) });
                    switchChannel(docRef.id, newChannelData.name);
                }
                addChannelInput.value = '';
                secretIdInput.value = '';
                isPrivateCheckbox.checked = false;
                secretIdInput.classList.add('hidden');
            } catch (error) { console.error("ãƒãƒ£ãƒ³ãƒãƒ«è¿½åŠ ã‚¨ãƒ©ãƒ¼:", error); }
        });
        joinPrivateForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const secretId = joinIdInput.value.trim();
            if (secretId === '' || !currentUser) return;
            const q = query(collection(db, "channels"), where("secretId", "==", secretId));
            const snapshot = await getDoc(q);
            if (snapshot.empty) {
                alert('IDï¼ˆåˆè¨€è‘‰ï¼‰ãŒé–“é•ã£ã¦ã„ã‚‹ã‹ã€ãƒãƒ£ãƒ³ãƒãƒ«ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚');
            } else {
                const foundDoc = snapshot.docs[0];
                const userRef = doc(db, "users", currentUser.uid);
                await updateDoc(userRef, { joinedPrivateChannels: arrayUnion(foundDoc.id) });
                switchChannel(foundDoc.id, foundDoc.data().name);
                joinIdInput.value = '';
            }
        });
        function switchChannel(channelId, channelName) {
            if (unsubscribeMessages) unsubscribeMessages();
            currentChannelId = channelId; 
            currentChannelName.textContent = channelName; 
            document.querySelectorAll('.channel-item').forEach(el => {
                el.classList.toggle('active', el.dataset.id === channelId);
            });
            listenToMessages(channelId);
        }

        // --- 3. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€å—ä¿¡å‡¦ç† (â˜…ç”»åƒå‡¦ç†ã‚’å‰Šé™¤â˜…) ---
        
        // â˜…ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ (ãƒ†ã‚­ã‚¹ãƒˆã®ã¿)
        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault(); 
            const text = messageInput.value.trim();

            if (text === '' || !currentUser) return; // ãƒ†ã‚­ã‚¹ãƒˆãŒç„¡ã‘ã‚Œã°ä½•ã‚‚ã—ãªã„

            try {
                // â˜…Firestoreã«ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ã ã‘ã‚’ä¿å­˜
                await addDoc(collection(db, "messages"), {
                    senderId: currentUser.uid, 
                    channelId: currentChannelId, 
                    timestamp: serverTimestamp(),
                    text: text // â˜…ãƒ†ã‚­ã‚¹ãƒˆã®ã¿
                    // (imageUrl ã¯ä¿å­˜ã—ãªã„)
                });
                
                messageInput.value = ''; // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢

            } catch (error) { 
                console.error("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‚¨ãƒ©ãƒ¼:", error); 
                alert("é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
            }
        });
        
        // å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åç°¿(users)ã®å¤‰æ›´ã‚’ç›£è¦– (å¤‰æ›´ãªã—)
        function listenToUsers() {
            const usersRef = collection(db, "users");
            onSnapshot(usersRef, (snapshot) => {
                snapshot.docs.forEach(doc => { usersMap[doc.id] = doc.data(); });
                renderAllMessages(); 
            });
        }
        
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸(messages)ã®å¤‰æ›´ã‚’ç›£è¦– (å¤‰æ›´ãªã—)
        function listenToMessages(channelId) {
            const q = query(
                collection(db, "messages"), 
                where("channelId", "==", channelId),
                orderBy("timestamp")
            );
            unsubscribeMessages = onSnapshot(q, (querySnapshot) => {
                currentMessages = querySnapshot.docs.map(doc => doc.data());
                renderAllMessages();
            });
        }
        
        // â˜…ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¹ãƒˆã‚’ç”»é¢ã«æç”»ã™ã‚‹ (ãƒ†ã‚­ã‚¹ãƒˆã®ã¿)
        function renderAllMessages() {
            messageList.innerHTML = ''; 
            currentMessages.forEach(msgData => { 
                const senderInfo = usersMap[msgData.senderId] || { displayName: 'ä¸æ˜ãªãƒ¦ãƒ¼ã‚¶ãƒ¼', photoURL: '' };
                // â˜…displayMessage ã« msgData.text ã ã‘ã‚’æ¸¡ã™
                displayMessage(senderInfo.displayName, senderInfo.photoURL, msgData.text);
            });
            messageList.scrollTop = messageList.scrollHeight;
        }

        // --- 4. â˜…ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºãƒ˜ãƒ«ãƒ‘ãƒ¼ (ãƒ†ã‚­ã‚¹ãƒˆã®ã¿)â˜… ---
        
        function displayMessage(name, icon, text) { // â˜…å¼•æ•°ã‚’ text ã«å¤‰æ›´
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message';
            
            const safeIcon = icon || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'; 
            
            // â˜…ãƒ†ã‚­ã‚¹ãƒˆã®å‡¦ç†ã®ã¿â˜…
            const safeText = text || ''; // (ç”»åƒã ã‘é€ã‚‰ã‚Œã¦ããŸå¤ã„ãƒ‡ãƒ¼ã‚¿å¯¾ç­–)
            const escapedText = safeText.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            const messageBodyHTML = `<div class="message-text">${escapedText}</div>`;
            
            // (ç”»åƒ (imageUrl) ã®å‡¦ç†ã¯å‰Šé™¤)

            msgDiv.innerHTML = `
                <img src="${safeIcon}" class="message-icon" alt="${name}">
                <div class="message-content">
                    <div class="message-sender">${name}</div>
                    ${messageBodyHTML}
                </div>
            `;
            messageList.appendChild(msgDiv);
        }
        
        // --- 5. ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å‡¦ç† (å¤‰æ›´ãªã—) ---
        settingsBtn.addEventListener('click', () => { profileModalOverlay.classList.remove('hidden'); });
        profileCancelBtn.addEventListener('click', () => { profileModalOverlay.classList.add('hidden'); });
        profileSaveBtn.addEventListener('click', async () => {
            const newName = profileNameInput.value.trim();
            const newIcon = profileIconInput.value.trim();
            if (newName === '' || newIcon === '') return alert('åå‰ã¨ã‚¢ã‚¤ã‚³ãƒ³URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            if (!currentUser) return;
            try {
                const userRef = doc(db, "users", currentUser.uid);
                await updateDoc(userRef, { displayName: newName, photoURL: newIcon });
                profileModalOverlay.classList.add('hidden');
            } catch (error) { console.error("ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–°ã‚¨ãƒ©ãƒ¼:", error); }
        });

    </script>
</body>
</html>